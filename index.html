<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Autokirim Barcode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f8fafc; }
        [x-cloak] { display: none !important; }
        
        #reader { width: 100%; height: 100%; background: #000; border-radius: 16px; overflow: hidden; }
        #reader video { width: 100% !important; height: 100% !important; object-fit: cover !important; }
        .scan-overlay { position: absolute; inset: 0; pointer-events: none; z-index: 10; display: flex; align-items: center; justify-content: center; }
        .scan-box { width: 90%; height: 35%; border-radius: 16px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.7); border: 2px solid rgba(255,255,255,0.5); position: relative; transition: all 0.2s; }
        .laser { position: absolute; left: 2%; width: 96%; height: 2px; background: #ef4444; box-shadow: 0 0 15px #ef4444; top: 50%; animation: laserAnim 2s infinite ease-in-out; }
        @keyframes laserAnim { 0% { transform: translateY(-20px); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateY(20px); opacity: 0; } }
        .flash-success .scan-box { border: 4px solid #22c55e !important; }
        .flash-error .scan-box { border: 4px solid #dc2626 !important; }

        .select-wrapper { position: relative; }
        .select-wrapper select { appearance: none; -webkit-appearance: none; padding-right: 2.5rem; background-image: none; }
        .select-arrow { pointer-events: none; position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: #64748b; transition: transform 0.2s; }
        .select-wrapper:focus-within .select-arrow { transform: translateY(-50%) rotate(180deg); color: #ef4444; }
        
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 110; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .modal-enter { animation: slideUp 0.35s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .row-card:hover { transform: scale-[1.01]; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .bg-mesh { background-color: #f8fafc; background-image: radial-gradient(at 0% 0%, hsla(349,100%,88%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(24,100%,88%,1) 0, transparent 50%); }
        
        .toggle-checkbox:checked { right: 0; border-color: #6366f1; }
        .toggle-checkbox:checked + .toggle-label { background-color: #6366f1; }
        .toggle-checkbox { right: 16px; transition: all 0.3s; }

        .sticky-th { position: sticky; top: 0; z-index: 30; background-color: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
        input[type="date"] { -webkit-appearance: none; appearance: none; min-height: 42px; }
        
        .custom-checkbox { width: 18px; height: 18px; border-radius: 4px; cursor: pointer; accent-color: #ef4444; }
        .queue-enter { animation: slideInLeft 0.3s ease-out; }
        @keyframes slideInLeft { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="bg-mesh text-slate-800 flex flex-col min-h-screen md:h-screen md:overflow-hidden" x-data="appData()" x-init="initApp()">

    <div x-show="isLoading" class="loading-overlay" x-transition>
        <div class="flex flex-col items-center text-center p-6 bg-white rounded-2xl shadow-xl">
            <div class="animate-spin rounded-full h-10 w-10 border-4 border-slate-100 border-t-red-600 mb-4"></div>
            <p class="text-sm font-bold text-slate-700" x-text="loadingText"></p>
        </div>
    </div>

    <div x-show="!isLoggedIn" class="fixed inset-0 z-[100] bg-[url('https://images.unsplash.com/photo-1557683316-973673baf926?q=80&w=2000&auto=format&fit=crop')] bg-cover bg-center flex items-center justify-center p-4" x-transition.opacity>
        <div class="absolute inset-0 bg-gradient-to-br from-indigo-900/90 to-purple-900/90 backdrop-blur-sm"></div>
        <div class="bg-white/95 backdrop-blur rounded-3xl shadow-2xl w-full max-w-sm p-8 text-center modal-enter relative z-10 border border-white/20">
            <div class="w-20 h-20 bg-gradient-to-tr from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center mx-auto mb-5 text-white shadow-lg shadow-purple-500/30 transform rotate-3"><i class="fas fa-rocket text-3xl"></i></div>
            <h1 class="text-2xl font-extrabold text-slate-800 mb-1">AUTOKIRIM SCANNER</h1>
            <p class="text-sm text-slate-500 mb-8 font-medium">Develop by Yarch</p>
            <form @submit.prevent="doLogin">
                <div class="mb-4 text-left select-wrapper">
                    <label class="text-[11px] font-bold text-slate-400 uppercase ml-1 mb-1 block tracking-wider">Pilih User</label>
                    <select x-model="selectedUser" class="w-full bg-slate-50 border border-slate-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-100 p-3.5 rounded-xl font-bold text-slate-700 outline-none transition-all cursor-pointer">
                        <option value="" disabled>-- Siapa kamu? --</option>
                        <option value="Admin">Admin Utama</option>
                        <option value="Erika">Erika</option>
                    </select>
                    <i class="fas fa-chevron-down select-arrow text-sm"></i>
                </div>
                <input type="password" x-model="loginPass" class="w-full bg-slate-50 border border-slate-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-100 p-3.5 rounded-xl font-bold text-center text-lg outline-none mb-6 transition-all placeholder:text-slate-300" placeholder="Password" autofocus>
                <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-purple-500/30 transition-all transform active:scale-95">MASUK SISTEM</button>
            </form>
        </div>
    </div>

    <div x-show="isLoggedIn" class="flex flex-col md:flex-row w-full md:h-full" x-cloak>
        <header class="md:hidden bg-gradient-to-r from-rose-600 via-red-600 to-orange-500 text-white p-3 shadow-md flex justify-between items-center z-30 relative shrink-0 sticky top-0">
            <div class="flex items-center gap-2.5">
                <div class="w-9 h-9 rounded-xl bg-white/20 backdrop-blur-sm flex items-center justify-center shadow-inner border border-white/30"><i class="fas fa-box-open text-sm"></i></div>
                <div><h1 class="font-extrabold text-sm tracking-tight text-white drop-shadow-sm">AUTOKIRIM</h1><p class="text-[10px] font-semibold text-white/80" x-text="selectedUser"></p></div>
            </div>
            <div class="flex gap-2">
                <button @click="showQrModal = true" class="w-9 h-9 rounded-full bg-white/20 hover:bg-white/30 text-white flex items-center justify-center transition-all border border-white/20"><i class="fas fa-qrcode"></i></button>
                <button @click="toggleView()" class="w-9 h-9 rounded-full bg-white/20 hover:bg-white/30 text-white flex items-center justify-center transition-all border border-white/20"><i class="fas" :class="currentView === 'home' ? 'fa-chart-pie' : 'fa-home'"></i></button>
                <button @click="logout()" class="w-9 h-9 rounded-full bg-white/20 hover:bg-white/30 text-white flex items-center justify-center transition-all border border-white/20"><i class="fas fa-power-off"></i></button>
            </div>
        </header>

        <aside class="w-full md:w-[400px] bg-white/80 backdrop-blur-md border-r border-slate-200 flex flex-col z-20 shadow-2xl shrink-0 h-auto md:h-full" x-show="currentView === 'home' || currentView === 'dashboard'">
            <div class="hidden md:flex h-20 bg-gradient-to-r from-rose-600 to-orange-600 text-white items-center px-6 justify-between shrink-0 shadow-md relative overflow-hidden">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                <div class="flex items-center gap-3 relative z-10">
                    <div class="w-10 h-10 rounded-xl bg-white/20 backdrop-blur-md flex items-center justify-center text-white border border-white/30 shadow-lg"><i class="fas fa-rocket text-lg"></i></div>
                    <div><h1 class="font-extrabold text-lg tracking-tight drop-shadow-md">AUTOKIRIM</h1><p class="text-xs font-medium text-white/80">Scanner</p></div>
                </div>
                <div class="relative z-10 flex gap-2">
                    <button @click="showQrModal = true" class="w-9 h-9 rounded-xl bg-white/20 hover:bg-white/30 text-white flex items-center justify-center transition-all border border-white/30 shadow-sm" title="QR Login"><i class="fas fa-qrcode"></i></button>
                    <button @click="logout()" class="w-9 h-9 rounded-xl bg-red-800/50 hover:bg-red-900/50 text-white flex items-center justify-center transition-all border border-white/30 shadow-sm" title="Keluar"><i class="fas fa-power-off"></i></button>
                </div>
            </div>
            
            <div class="md:flex-1 md:overflow-y-auto p-5 space-y-5">
                <div class="hidden md:flex bg-slate-100 p-1 rounded-xl mb-2 shadow-inner">
                    <button @click="currentView = 'home'" class="flex-1 py-2.5 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2" :class="currentView === 'home' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-400 hover:text-slate-600'"><i class="fas fa-list"></i> DATA SCAN</button>
                    <button @click="toggleView()" class="flex-1 py-2.5 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2" :class="currentView === 'dashboard' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-400 hover:text-slate-600'"><i class="fas fa-chart-pie"></i> STATISTIK</button>
                </div>

                <div class="bg-indigo-50 p-4 rounded-2xl border border-indigo-200 shadow-sm relative overflow-hidden" x-show="currentView === 'home'">
                    <div class="flex justify-between items-center mb-2 relative z-10">
                        <label class="text-[11px] font-bold text-indigo-700 uppercase tracking-wider flex items-center gap-1.5"><i class="fas fa-desktop text-indigo-500"></i> Sambungan PC</label>
                        <div class="relative inline-block w-10 h-5 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="pcToggle" x-model="pcLinkEnabled" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-2 border-indigo-300 appearance-none cursor-pointer top-0"/>
                            <label for="pcToggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-indigo-200 cursor-pointer"></label>
                        </div>
                    </div>
                    <div x-show="pcLinkEnabled" class="mt-2 relative z-10" x-transition>
                        <input type="text" x-model="pcIpAddress" class="w-full p-2.5 text-xs font-mono font-bold border border-indigo-200 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none bg-white text-center text-indigo-800 placeholder:text-indigo-300 transition-all" placeholder="IP Laptop (Cth: 192.168.1.5)">
                        <p class="text-[9px] text-indigo-500 mt-1.5 text-center flex items-center justify-center gap-1"><i class="fas fa-info-circle"></i> Pastikan script Python aktif di Laptop.</p>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-amber-50 to-orange-50 p-4 rounded-2xl border border-orange-200 shadow-sm" x-show="hasOldData && currentView === 'home'">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-8 h-8 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center animate-bounce"><i class="fas fa-exclamation-triangle"></i></div>
                        <div><h3 class="text-xs font-bold text-orange-900">Data Offline Tersimpan!</h3><p class="text-[10px] text-orange-700">Segera upload agar tidak hilang.</p></div>
                    </div>
                    <button @click="migrateAllData()" class="w-full bg-gradient-to-r from-orange-500 to-amber-500 hover:from-orange-600 hover:to-amber-600 text-white py-2.5 rounded-xl text-xs font-bold shadow-md shadow-orange-500/20 transition-all">Upload Sekarang</button>
                </div>

                <div class="bg-gradient-to-b from-white to-slate-50 p-4 rounded-2xl border border-slate-200 shadow-sm" x-show="currentView === 'home'">
                    <div class="flex justify-between items-center mb-3">
                        <label class="text-[11px] font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1"><i class="fas fa-sliders-h text-rose-500"></i> Pengaturan</label>
                        <span class="text-[10px] bg-rose-50 text-rose-600 px-2 py-1 rounded-md border border-rose-100 font-bold shadow-sm">Manual Mode</span>
                    </div>
                    <div class="flex gap-2 overflow-x-auto hide-scroll mb-3 pb-1 cursor-grab active:cursor-grabbing select-none" x-data="dragScroll()" @mousedown="start($event)" @mouseleave="stop()" @mouseup="stop()" @mousemove="move($event)">
                        <template x-for="mp in marketplaces" :key="mp.name">
                            <button @click="if(!isDragging) selectedMp = mp.name" class="whitespace-nowrap px-4 py-2.5 rounded-xl text-xs font-bold border transition-all flex items-center gap-2 shrink-0 shadow-sm" 
                            :class="selectedMp === mp.name ? 'bg-slate-800 text-white border-slate-800 ring-2 ring-slate-200' : 'bg-white text-slate-500 border-slate-200 hover:border-slate-300 hover:bg-slate-50'">
                                <i class="fas" :class="mp.icon" :style="selectedMp === mp.name ? 'color: #fbbf24' : ''"></i> <span x-text="mp.name"></span>
                            </button>
                        </template>
                    </div>
                    <div class="space-y-3">
                        <div x-show="selectedMp === 'Manual'" class="bg-slate-100 p-1 rounded-xl flex shadow-inner">
                            <button @click="isCODInput = true" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all" :class="isCODInput ? 'bg-white text-green-600 shadow-sm border border-slate-100' : 'text-slate-400 hover:text-slate-600'">COD (Bayar)</button>
                            <button @click="isCODInput = false" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all" :class="!isCODInput ? 'bg-white text-blue-600 shadow-sm border border-slate-100' : 'text-slate-400 hover:text-slate-600'">Non-COD</button>
                        </div>
                        <div class="select-wrapper">
                            <select x-model="selectedCourier" class="w-full bg-white border border-slate-200 text-slate-800 text-sm font-bold rounded-xl p-3 outline-none focus:border-rose-500 focus:ring-2 focus:ring-rose-50 transition-all cursor-pointer shadow-sm appearance-none">
                                <template x-for="c in couriers" :key="c"><option :value="c" x-text="c"></option></template>
                            </select>
                            <i class="fas fa-truck-fast select-arrow text-xs text-rose-400"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-900 p-1.5 rounded-2xl shadow-xl shadow-rose-200/50 relative group overflow-hidden border-2 border-slate-800" x-show="currentView === 'home'">
                    <div class="relative w-full h-48 md:h-56 bg-black rounded-xl overflow-hidden" :class="scanStatusClass">
                        <div x-show="!isCameraActive" @click="toggleCamera()" class="absolute inset-0 flex flex-col items-center justify-center cursor-pointer text-slate-500 z-10 hover:text-slate-400 transition bg-gradient-to-b from-slate-800 to-black">
                            <div class="w-16 h-16 rounded-full bg-slate-800 flex items-center justify-center mb-3 ring-4 ring-slate-700/50 shadow-lg shadow-rose-500/20 group-hover:scale-110 transition-transform"><i class="fas fa-camera text-2xl text-rose-400"></i></div>
                            <span class="text-[10px] font-bold uppercase tracking-widest text-slate-400 group-hover:text-rose-400 transition-colors">Ketuk Kamera</span>
                        </div>
                        <div id="reader" x-show="isCameraActive"></div>
                        <div x-show="isCameraActive" class="scan-overlay"><div class="scan-box"><div class="laser"></div></div></div>
                    </div>
                    <button @click="toggleCamera()" class="absolute bottom-4 right-4 w-12 h-12 rounded-full flex items-center justify-center shadow-lg backdrop-blur-md transition-all z-20 border border-white/20" :class="isCameraActive ? 'bg-red-500/80 text-white' : 'bg-white/10 text-white hover:bg-white/20'"><i class="fas" :class="isCameraActive ? 'fa-stop' : 'fa-play pl-1'"></i></button>
                </div>

                <div class="mt-2 flex items-center justify-between bg-slate-100 p-2 rounded-xl" x-show="currentView === 'home'">
                    <span class="text-[10px] font-bold text-slate-500 uppercase ml-1">Scan Massal</span>
                    <button @click="isBatchMode = !isBatchMode" class="text-[10px] px-3 py-1.5 rounded-lg font-bold transition-all" :class="isBatchMode ? 'bg-rose-600 text-white shadow-md' : 'bg-white text-slate-400 shadow-sm'">
                        <i class="fas" :class="isBatchMode ? 'fa-bolt' : 'fa-toggle-off'"></i> <span x-text="isBatchMode ? 'ON' : 'OFF'"></span>
                    </button>
                </div>

                <div x-show="isBatchMode && batchQueue.length > 0 && currentView === 'home'" class="mt-2 bg-white border border-rose-200 rounded-xl p-3 shadow-sm modal-enter">
                    <div class="flex justify-between items-center mb-2 pb-2 border-b border-rose-50">
                        <span class="text-xs font-bold text-rose-600">Antrian: <span x-text="batchQueue.length"></span> Paket</span>
                        <div class="flex gap-1">
                            <button @click="if(confirm('Hapus semua antrian?')) batchQueue=[]" class="bg-gray-200 hover:bg-gray-300 text-gray-600 text-[10px] px-2 py-1.5 rounded-lg font-bold transition-all">BATAL SEMUA</button>
                            <button @click="saveBatch()" class="bg-rose-600 hover:bg-rose-700 text-white text-[10px] px-3 py-1.5 rounded-lg font-bold shadow-md transition-all animate-pulse">UPLOAD <i class="fas fa-cloud-upload-alt ml-1"></i></button>
                        </div>
                    </div>
                    <div class="max-h-32 overflow-y-auto space-y-1 pr-1 custom-scrollbar">
                        <template x-for="(q, idx) in batchQueue" :key="idx">
                            <div class="flex justify-between items-center text-[10px] bg-slate-50 p-2 rounded border border-slate-100 queue-enter hover:bg-rose-50 transition-colors group">
                                <div class="flex flex-col">
                                    <span class="font-mono font-bold text-slate-700" x-text="q.code"></span>
                                    <span class="text-[9px] text-slate-400" x-text="q.courier"></span>
                                </div>
                                <button @click="batchQueue.splice(idx, 1)" class="text-slate-300 hover:text-red-500 p-1"><i class="fas fa-times"></i></button>
                            </div>
                        </template>
                    </div>
                </div>

                <div class="flex gap-2 mt-3" x-show="currentView === 'home'">
                    <input type="text" id="barcodeInput" x-model="barcodeInput" @keydown.enter="preProcessScan()" class="w-full bg-white border border-slate-200 text-slate-900 text-sm font-bold rounded-xl p-3.5 outline-none focus:border-rose-500 focus:ring-2 focus:ring-rose-50 uppercase font-mono shadow-sm placeholder:text-slate-300 transition-all" placeholder="KETIK RESI..." autocomplete="off">
                    <button @click="preProcessScan()" class="bg-slate-800 hover:bg-slate-900 text-white px-5 rounded-xl shadow-lg shadow-slate-300 transition-all"><i class="fas fa-arrow-right"></i></button>
                </div>
                
                <div class="pt-2" x-show="currentView === 'home'">
                    <button @click="refreshData()" class="w-full bg-white hover:bg-blue-50 text-blue-600 py-3 rounded-xl font-bold text-xs mt-2 border border-blue-100 transition-all flex items-center justify-center gap-2 group shadow-sm"><i class="fas fa-sync group-hover:rotate-180 transition-transform duration-500 text-blue-400"></i> SINKRONISASI MANUAL</button>
                </div>
                
                <div class="pt-6 mt-4 border-t border-slate-100" x-show="currentView === 'home'">
                    <button @click="shareToWA()" class="w-full bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-emerald-500/30 mb-3 flex items-center justify-center gap-2 transition-all transform hover:-translate-y-0.5"><i class="fab fa-whatsapp text-xl"></i> SHARE LAPORAN WA</button>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <button @click="openManifestManager()" class="bg-slate-800 hover:bg-slate-900 text-white py-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2 shadow-lg shadow-slate-200 transition-all"><i class="fas fa-print text-yellow-400"></i> MANIFEST</button>
                        <button @click="exportExcel()" class="bg-teal-600 hover:bg-teal-700 text-white py-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2 shadow-lg shadow-teal-500/20 transition-all"><i class="fas fa-file-excel"></i> EXCEL</button>
                    </div>
                    <button @click="showDeleteModal = true" class="w-full bg-rose-50 text-rose-600 py-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2 hover:bg-rose-100 transition-colors"><i class="fas fa-trash-alt"></i> HAPUS DATA DATABASE</button>
                </div>
            </div>
        </aside>

        <main class="flex-1 bg-white/50 flex flex-col relative md:overflow-hidden" x-show="currentView === 'home'" x-transition.opacity>
            <div class="bg-white/80 backdrop-blur-sm border-b border-slate-200 sticky top-0 z-40">
                <div class="flex items-center gap-3 px-4 py-3 overflow-x-auto hide-scroll">
                    <div class="flex items-center gap-2 pl-2 pr-4 py-2 bg-gradient-to-r from-slate-800 to-slate-900 text-white rounded-2xl shrink-0 shadow-lg shadow-slate-300">
                        <div class="w-6 h-6 rounded-full bg-white/20 flex items-center justify-center text-[10px]"><i class="fas fa-box"></i></div>
                        <div><p class="text-[9px] uppercase font-bold text-slate-300">Total</p><p class="text-sm font-bold leading-none" x-text="filteredData.length"></p></div>
                    </div>
                    <div class="flex items-center gap-2 pl-2 pr-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-2xl shrink-0 shadow-lg shadow-green-200">
                        <div class="w-6 h-6 rounded-full bg-white/20 flex items-center justify-center text-[10px]"><i class="fas fa-wallet"></i></div>
                        <div><p class="text-[9px] uppercase font-bold text-green-100">COD</p><p class="text-sm font-bold leading-none" x-text="formatRupiah(totalCOD)"></p></div>
                    </div>
                    <div class="flex items-center gap-2 pl-2 pr-4 py-2 bg-gradient-to-r from-blue-500 to-cyan-600 text-white rounded-2xl shrink-0 shadow-lg shadow-blue-200">
                        <div class="w-6 h-6 rounded-full bg-white/20 flex items-center justify-center text-[10px]"><i class="fas fa-credit-card"></i></div>
                        <div><p class="text-[9px] uppercase font-bold text-blue-100">Non-COD</p><p class="text-sm font-bold leading-none" x-text="formatRupiah(totalNonCOD)"></p></div>
                    </div>
                </div>

                <div class="p-3 space-y-3 bg-white/50 border-t border-slate-100">
                    <div class="flex gap-2">
                        <div class="shrink-0 w-36">
                            <input type="date" x-model="filterDate" class="w-full bg-white border border-slate-200 text-slate-700 text-xs font-bold rounded-xl focus:border-rose-500 focus:ring-2 focus:ring-rose-50 p-2.5 outline-none shadow-sm transition-all" title="Filter Tanggal">
                        </div>
                        <div class="relative flex-1 group">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-slate-400 group-focus-within:text-rose-500 transition-colors"><i class="fas fa-search"></i></div>
                            <input type="text" x-model="searchQuery" class="bg-white border border-slate-200 text-slate-800 text-xs rounded-xl focus:border-rose-500 focus:ring-2 focus:ring-rose-50 block w-full pl-9 p-2.5 font-bold uppercase shadow-sm transition-all" placeholder="Cari Resi / Nama...">
                        </div>
                    </div>
                    
                    <div class="flex gap-2 overflow-x-auto hide-scroll pb-1 cursor-grab active:cursor-grabbing select-none" x-data="dragScroll()" @mousedown="start($event)" @mouseleave="stop()" @mouseup="stop()" @mousemove="move($event)">
                        <button @click="if(!isDragging) activeFilter = 'ALL'" class="px-4 py-1.5 rounded-full border shrink-0 text-[11px] font-bold transition-all shadow-sm" :class="activeFilter === 'ALL' ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'">SEMUA</button>
                        <template x-for="(count, courier) in getSummary()" :key="courier">
                            <button @click="if(!isDragging) activeFilter = (activeFilter === courier ? 'ALL' : courier)" class="px-3 py-1.5 rounded-full border shrink-0 text-[11px] font-bold transition-all flex items-center gap-1.5 shadow-sm" :class="activeFilter === courier ? 'bg-rose-600 text-white border-rose-600' : 'bg-white text-slate-600 border-slate-200 hover:border-rose-200'">
                                <span x-text="courier"></span>
                                <span class="px-1.5 py-0.5 rounded-full text-[9px] min-w-[18px] text-center" :class="activeFilter === courier ? 'bg-white/20 text-white' : 'bg-slate-100 text-slate-500'" x-text="count"></span>
                            </button>
                        </template>
                    </div>
                </div>
            </div>

            <div class="md:flex-1 md:overflow-y-auto p-0 md:p-4 bg-transparent pb-32 md:pb-28"> 
                <div class="md:rounded-2xl md:shadow-sm min-h-full relative">
                    <table class="w-full text-left table-fixed border-collapse">
                        <thead class="sticky-header">
                            <tr class="border-b border-slate-100">
                                <th class="p-4 w-[10%] text-center sticky-col-header"><input type="checkbox" @change="toggleAll($event)" class="custom-checkbox"></th>
                                <th class="p-4 text-[10px] font-extrabold text-slate-400 uppercase w-[20%] tracking-wider sticky-col-header">Waktu</th>
                                <th class="p-4 text-[10px] font-extrabold text-slate-400 uppercase w-[35%] tracking-wider sticky-col-header">Info Paket</th>
                                <th class="p-4 text-[10px] font-extrabold text-slate-400 uppercase w-[35%] text-right tracking-wider sticky-col-header">Status</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 bg-white">
                            <template x-for="item in filteredData" :key="item.code">
                                <tr class="transition duration-200 cursor-pointer group row-card relative border-l-[6px]" :class="getCourierColor(item.courier)" @click="openEditModal(item)">
                                    <td class="p-4 align-top text-center" @click.stop>
                                        <input type="checkbox" :value="item.code" x-model="selectedRows" class="custom-checkbox">
                                    </td>
                                    <td class="p-4 align-top">
                                        <div class="text-[10px] font-bold text-slate-800 mb-0.5" x-text="item.dayName || '-'"></div>
                                        <div class="text-[9px] text-slate-400 font-mono" x-text="formatDateID(item.date)"></div>
                                        <div class="text-[10px] text-slate-500 font-mono mt-0.5"><i class="far fa-clock text-[9px] mr-0.5 opacity-70"></i> <span x-text="item.time"></span></div>
                                        <div class="text-[9px] text-slate-400 mt-1 flex items-center gap-1"><i class="fas fa-user-circle text-[8px]"></i> <span x-text="item.admin || 'System'"></span></div>
                                        <div x-show="isPrinted(item.code)" class="mt-1 inline-block px-1.5 py-0.5 rounded bg-emerald-100 text-emerald-700 text-[8px] font-bold border border-emerald-200"><i class="fas fa-check-circle"></i> PRINTED</div>
                                    </td>
                                    <td class="p-4 align-top">
                                        <div class="inline-block bg-slate-50 border border-slate-100 px-2 py-1 rounded mb-2 w-full">
                                            <div class="text-sm font-bold text-slate-800 font-mono tracking-wide break-all leading-tight group-hover:text-rose-600 transition-colors" x-text="item.code"></div>
                                        </div>
                                        <div class="flex flex-wrap gap-1.5 items-center">
                                            <span class="text-[9px] font-bold text-slate-600 bg-slate-100 px-2 py-0.5 rounded border border-slate-200" x-text="item.courier"></span>
                                            <span class="text-[9px] font-bold text-white px-2 py-0.5 rounded shadow-sm" :class="getMpColor(item.marketplace)" x-text="item.marketplace"></span>
                                            <div x-show="item.photoUrl" @click.stop="window.open(item.photoUrl, '_blank')" class="text-blue-500 bg-blue-50 hover:bg-blue-100 p-1 rounded cursor-pointer"><i class="fas fa-image"></i></div>
                                        </div>
                                    </td>
                                    <td class="p-4 align-top text-right">
                                        <div class="flex flex-col items-end gap-1 mb-2">
                                            <div class="text-xs font-bold text-blue-700 bg-blue-50 border border-blue-200 px-2 py-0.5 rounded">
                                                <span x-text="formatRupiah(item.price)"></span>
                                            </div>
                                            <div class="flex items-center gap-1 mt-1">
                                                <span x-show="item.weight" class="text-[9px] text-slate-500 font-bold bg-slate-100 px-1 rounded"><span x-text="item.weight"></span>Kg</span>
                                                <span class="text-[9px] uppercase font-extrabold px-1.5 py-0.5 rounded" :class="item.isCOD ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'" x-text="item.isCOD ? 'COD' : 'NON COD'"></span>
                                            </div>
                                        </div>
                                        <div class="text-[10px] text-slate-700 truncate max-w-[120px] ml-auto font-bold" x-text="item.receiver || '-'"></div>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="filteredData.length === 0">
                                <td colspan="4" class="p-10 text-center text-slate-400 text-sm bg-slate-50/50">
                                    <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-3 text-rose-200 shadow-md"><i class="fas fa-search text-3xl"></i></div>
                                    <span x-show="!searchQuery && onlineData.length > 0">Tidak ada data di tanggal <b x-text="formatDateID(filterDate)"></b>.<br><span class="text-rose-600 cursor-pointer underline font-bold hover:text-rose-700" @click="filterDate = ''">TAMPILKAN SEMUA DATA</span></span>
                                    <span x-show="!searchQuery && onlineData.length === 0">Belum ada data. <br><span class="text-xs opacity-70">Mulai scan paket sekarang!</span></span>
                                    <span x-show="searchQuery">Resi tidak ditemukan.</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div x-show="selectedRows.length > 0" class="fixed bottom-4 left-4 right-4 md:left-[420px] z-50 modal-enter" x-cloak>
                <div class="bg-slate-900 text-white p-4 rounded-2xl shadow-2xl flex justify-between items-center border border-slate-700">
                    <div class="flex items-center gap-3">
                        <div class="bg-rose-600 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm" x-text="selectedRows.length"></div>
                        <span class="font-bold text-sm">Item Terpilih</span>
                    </div>
                    <button @click="deleteSelected()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl font-bold text-xs shadow-lg transition-all"><i class="fas fa-trash-alt mr-1"></i> HAPUS</button>
                </div>
            </div>
        </main>

        <main class="flex-1 bg-white flex flex-col overflow-y-auto p-4 md:p-8" x-show="currentView === 'dashboard'" x-transition.opacity>
             <div class="mb-6 flex justify-between items-end">
                <div>
                    <h2 class="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-rose-600 to-orange-600 tracking-tight">Dashboard Overview</h2>
                    <p class="text-sm text-slate-500 font-medium mt-1">Statistik Harian: <span class="text-slate-800 font-bold bg-slate-100 px-2 py-0.5 rounded border border-slate-200" x-text="formatDateID(filterDate)"></span></p>
                </div>
                <button @click="toggleView()" class="text-xs font-bold text-slate-500 hover:text-rose-600 bg-white px-3 py-2 rounded-lg border border-slate-200 hover:border-rose-200 transition-all shadow-sm">Kembali <i class="fas fa-arrow-right ml-1"></i></button>
            </div>
            
            <div x-show="['Admin','Erika'].includes(selectedUser)" class="mb-6 bg-gradient-to-r from-yellow-400 to-amber-500 p-6 rounded-2xl shadow-lg text-white flex items-center justify-between">
                <div>
                    <p class="text-xs font-bold text-amber-100 uppercase tracking-widest mb-1">Estimasi Profit Hari Ini</p>
                    <h2 class="text-4xl font-extrabold" x-text="formatRupiah(totalProfit)"></h2>
                </div>
                <div class="w-14 h-14 bg-white/20 rounded-2xl flex items-center justify-center backdrop-blur-sm"><i class="fas fa-coins text-3xl"></i></div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 row-card group">
                    <div class="w-10 h-10 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center mb-3 group-hover:bg-blue-600 group-hover:text-white transition-colors"><i class="fas fa-cube text-lg"></i></div>
                    <div class="text-2xl font-extrabold text-slate-800" x-text="filteredData.length"></div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Total Paket</div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 row-card group">
                    <div class="w-10 h-10 rounded-xl bg-green-50 text-green-600 flex items-center justify-center mb-3 group-hover:bg-green-600 group-hover:text-white transition-colors"><i class="fas fa-wallet text-lg"></i></div>
                    <div class="text-2xl font-extrabold text-slate-800" x-text="filteredData.filter(i=>i.isCOD).length"></div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Paket COD</div>
                </div>
                <div class="bg-gradient-to-br from-rose-600 to-orange-600 p-4 rounded-2xl shadow-lg shadow-rose-500/30 row-card text-white">
                    <div class="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center mb-3 backdrop-blur-sm"><i class="fas fa-truck text-lg"></i></div>
                    <div class="text-2xl font-extrabold" x-text="Object.keys(getSummary()).length"></div>
                    <div class="text-[10px] font-bold text-rose-100 uppercase tracking-wider">Ekspedisi Aktif</div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 row-card group">
                    <div class="w-10 h-10 rounded-xl bg-purple-50 text-purple-600 flex items-center justify-center mb-3 group-hover:bg-purple-600 group-hover:text-white transition-colors"><i class="fas fa-users text-lg"></i></div>
                    <div class="text-2xl font-extrabold text-slate-800" x-text="Object.keys(getAdminStats()).length"></div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Admin Aktif</div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                    <h3 class="text-sm font-bold text-slate-800 mb-4 flex items-center gap-2"><div class="w-2 h-5 bg-rose-500 rounded-full"></div> Distribusi Ekspedisi</h3>
                    <div class="relative h-64"><canvas id="courierChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                    <h3 class="text-sm font-bold text-slate-800 mb-4 flex items-center gap-2"><div class="w-2 h-5 bg-blue-500 rounded-full"></div> Metode Pembayaran</h3>
                    <div class="relative h-64"><canvas id="paymentChart"></canvas></div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 mb-10">
                <h3 class="text-sm font-bold text-slate-800 mb-4 flex items-center gap-2"><div class="w-2 h-5 bg-slate-800 rounded-full"></div> Leaderboard Admin</h3>
                <div class="overflow-hidden rounded-xl border border-slate-100">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 uppercase text-[10px] font-bold tracking-wider"><tr><th class="p-3">Admin</th><th class="p-3 text-right">Jumlah Scan</th></tr></thead>
                        <tbody class="divide-y divide-slate-50">
                            <template x-for="(count, user) in getAdminStats()" :key="user">
                                <tr class="hover:bg-slate-50/50 transition">
                                    <td class="p-3 font-bold text-slate-700 flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-slate-700 to-slate-900 text-white flex items-center justify-center text-xs shadow-md shadow-slate-200" x-text="user.charAt(0)"></div>
                                        <span x-text="user"></span>
                                    </td>
                                    <td class="p-3 text-right">
                                        <span class="bg-rose-50 text-rose-700 border border-rose-100 px-3 py-1 rounded-full font-bold text-xs" x-text="count + ' Paket'"></span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div x-show="showDetailModal" class="fixed inset-0 bg-slate-900/90 z-[100] flex items-start justify-center p-4 backdrop-blur-sm overflow-y-auto" x-cloak>
        <div class="bg-white w-full md:max-w-md rounded-3xl shadow-2xl overflow-hidden modal-enter mt-4 md:mt-10 mb-20 relative">
            <div class="bg-slate-900 p-5 text-white flex justify-between items-center relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-r from-rose-600 to-orange-600 opacity-90"></div>
                <h3 class="font-bold flex items-center gap-2 relative z-10 text-lg"><i class="fas" :class="isEditMode ? 'fa-edit' : 'fa-cloud-upload-alt'"></i> <span x-text="isEditMode ? 'Edit Paket' : 'Konfirmasi Paket'"></span></h3>
                <button @click="printStruk(tempItem)" class="text-[10px] bg-white text-rose-600 px-3 py-1.5 rounded-full font-bold hover:bg-slate-100 relative z-10 shadow-lg"><i class="fas fa-print mr-1"></i> STRUK</button>
            </div>
            <div class="p-6 space-y-4 bg-slate-50">
                <div class="bg-white p-4 rounded-2xl border border-slate-200 text-center shadow-sm relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full" :class="getCourierColor(tempItem.courier).replace('border-l-[6px]', 'bg')"></div>
                    <p class="text-xl font-mono font-bold text-slate-800 break-all" x-text="tempItem.code"></p>
                    <div class="flex justify-center gap-2 mt-3">
                        <span class="text-[10px] font-bold px-2.5 py-1 rounded-full bg-slate-100 text-slate-600 border border-slate-200" x-text="tempItem.courier"></span>
                        <span class="text-[10px] font-bold px-2.5 py-1 rounded-full bg-white text-slate-600 border border-slate-200 shadow-sm" x-text="tempItem.marketplace"></span>
                    </div>
                </div>
                
                <div class="flex justify-center gap-2">
                    <button @click="tempItem.method = 'Pick Up'" class="flex-1 py-2 rounded-xl font-bold text-xs border transition-all" :class="tempItem.method === 'Pick Up' ? 'bg-purple-600 text-white border-purple-600 shadow-md' : 'bg-white text-slate-400 border-slate-200'">PICK UP</button>
                    <button @click="tempItem.method = 'Drop Off'" class="flex-1 py-2 rounded-xl font-bold text-xs border transition-all" :class="tempItem.method === 'Drop Off' ? 'bg-blue-500 text-white border-blue-500 shadow-md' : 'bg-white text-slate-400 border-slate-200'">DROP OFF</button>
                </div>

                <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Bukti Foto</label>
                        <span x-show="tempItem.photoBase64" class="text-[9px] text-green-600 font-bold bg-green-50 px-2 py-0.5 rounded">Foto Diambil</span>
                    </div>
                    
                    <div class="flex gap-2">
                        <div x-show="tempItem.photoBase64" class="w-16 h-16 rounded-lg bg-slate-100 border border-slate-200 overflow-hidden flex-shrink-0 cursor-pointer" @click="window.open(tempItem.photoBase64)">
                            <img :src="tempItem.photoBase64" class="w-full h-full object-cover">
                        </div>
                        
                        <label class="flex-1 cursor-pointer">
                            <div class="w-full h-full min-h-[40px] border-2 border-dashed border-slate-300 rounded-xl flex items-center justify-center gap-2 hover:bg-slate-50 transition-colors text-slate-400 hover:text-slate-600">
                                <i class="fas fa-camera"></i> <span class="text-xs font-bold">Ambil Foto</span>
                            </div>
                            <input type="file" accept="image/*" capture="environment" class="hidden" @change="processPhoto($event)">
                        </label>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
                    <div class="flex justify-between items-center mb-3">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Jenis & Ongkir</label>
                        <div class="flex bg-slate-100 rounded-lg p-1">
                            <button @click="tempItem.isCOD = true" class="text-[10px] font-bold px-3 py-1 rounded-md transition-all" :class="tempItem.isCOD ? 'bg-white text-green-600 shadow-sm' : 'text-slate-400'">COD</button>
                            <button @click="tempItem.isCOD = false" class="text-[10px] font-bold px-3 py-1 rounded-md transition-all" :class="!tempItem.isCOD ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400'">NON</button>
                        </div>
                    </div>
                    <input type="number" x-model="tempItem.price" class="w-full text-3xl font-bold text-center outline-none bg-transparent border-b border-slate-200 pb-2">
                </div>
                <input type="text" x-model="tempItem.receiver" class="w-full p-4 text-sm border border-slate-200 rounded-xl" placeholder="Nama Penerima">
                <div class="flex gap-3">
                    <input type="text" x-model="tempItem.destination" class="w-full p-4 text-sm border border-slate-200 rounded-xl" placeholder="Kota Tujuan">
                    <input type="text" x-model="tempItem.weight" class="w-24 p-4 text-sm border border-slate-200 rounded-xl text-center" placeholder="Kg">
                </div>
                <div class="flex gap-3 mt-6">
                    <button @click="showDetailModal = false" class="flex-1 py-3.5 rounded-xl font-bold text-slate-500 bg-white border border-slate-200 hover:bg-slate-50 transition-colors">Batal</button>
                    <button @click="saveData()" class="flex-[2] bg-gradient-to-r from-rose-600 to-orange-600 hover:from-rose-700 hover:to-orange-700 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-rose-500/30 transition-all transform active:scale-95" x-text="isEditMode ? 'UPDATE DATA' : 'SIMPAN DATA'"></button>
                </div>
            </div>
        </div>
    </div>

    <div x-show="showManifestManager" class="fixed inset-0 bg-slate-900/90 z-[100] flex items-center justify-center p-4 backdrop-blur-sm" x-cloak x-transition.opacity>
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl h-[85vh] flex flex-col overflow-hidden modal-enter relative">
            <div class="bg-slate-900 p-4 text-white flex justify-between items-center shrink-0">
                <div class="flex items-center gap-3">
                    <div class="bg-rose-600 p-2 rounded-lg"><i class="fas fa-print"></i></div>
                    <div><h3 class="font-bold text-lg">Kelola Surat Jalan</h3><p class="text-[10px] text-slate-400">Pilih paket yang akan diproses print.</p></div>
                </div>
                <button @click="showManifestManager = false" class="text-slate-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex border-b border-slate-200 bg-slate-50 p-2 gap-2 shrink-0">
                <button @click="manifestTab = 'new'" class="flex-1 py-2 rounded-lg font-bold text-xs transition-all flex items-center justify-center gap-2" :class="manifestTab === 'new' ? 'bg-white text-rose-600 shadow-sm border border-slate-200' : 'text-slate-500 hover:bg-slate-100'"><i class="fas fa-plus-circle"></i> BUAT BARU</button>
                <button @click="manifestTab = 'history'" class="flex-1 py-2 rounded-lg font-bold text-xs transition-all flex items-center justify-center gap-2" :class="manifestTab === 'history' ? 'bg-white text-blue-600 shadow-sm border border-slate-200' : 'text-slate-500 hover:bg-slate-100'"><i class="fas fa-history"></i> RIWAYAT</button>
            </div>
            <div x-show="manifestTab === 'new'" class="flex-1 flex flex-col overflow-hidden bg-white">
                <div class="p-4 border-b border-slate-100 bg-white grid grid-cols-1 md:grid-cols-2 gap-3 shrink-0">
                    <div class="select-wrapper">
                        <select x-model="manifestCourier" class="w-full bg-slate-50 border border-slate-200 text-slate-800 text-xs font-bold rounded-xl p-2.5 outline-none focus:border-rose-500">
                            <option value="ALL">SEMUA EKSPEDISI</option>
                            <template x-for="c in couriers" :key="c"><option :value="c" x-text="c"></option></template>
                        </select>
                        <i class="fas fa-chevron-down select-arrow text-xs text-slate-400"></i>
                    </div>
                    <div class="flex items-center gap-2 bg-slate-50 border border-slate-200 rounded-xl p-2">
                        <input type="date" x-model="manifestFilterDate" class="bg-transparent text-xs font-bold outline-none w-24">
                        <div class="h-4 w-[1px] bg-slate-300"></div>
                        <input type="time" x-model="manifestStartTime" class="bg-transparent text-xs font-bold outline-none w-full">
                        <span class="text-slate-300">-</span>
                        <input type="time" x-model="manifestEndTime" class="bg-transparent text-xs font-bold outline-none w-full">
                    </div>
                    <div class="md:col-span-2 flex items-center justify-end">
                        <span class="text-[10px] text-slate-400 font-bold mr-2"><span x-text="getPendingItems().length"></span> Item</span>
                        <button @click="selectAllManifestItems()" class="text-[10px] bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1.5 rounded-lg font-bold transition-all">Pilih Semua</button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-2 bg-slate-50/50">
                    <template x-for="item in getPendingItems()" :key="item.code">
                        <div class="flex items-center gap-3 p-3 bg-white border border-slate-100 rounded-xl mb-2 hover:shadow-sm transition-all cursor-pointer" @click="toggleManifestItem(item.code)">
                            <div class="relative flex items-center justify-center w-5 h-5 rounded border" :class="selectedManifestItems.includes(item.code) ? 'bg-rose-500 border-rose-500' : 'bg-white border-slate-300'">
                                <i x-show="selectedManifestItems.includes(item.code)" class="fas fa-check text-white text-[10px]"></i>
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between">
                                    <span class="font-bold text-xs text-slate-800 font-mono" x-text="item.code"></span>
                                    <span class="text-[10px] font-bold text-slate-400" x-text="item.time"></span>
                                </div>
                                <div class="flex gap-2 mt-1 items-center">
                                    <span class="text-[9px] bg-slate-100 px-1.5 rounded text-slate-700 font-bold border border-slate-200" x-text="item.courier"></span>
                                    <span class="text-[9px] bg-slate-50 px-1.5 rounded text-slate-500" x-text="item.marketplace"></span>
                                    <span class="text-[9px] px-1.5 rounded font-bold" :class="item.isCOD ? 'bg-green-50 text-green-600' : 'bg-blue-50 text-blue-600'" x-text="item.isCOD ? 'COD' : 'NON'"></span>
                                </div>
                            </div>
                        </div>
                    </template>
                     <div x-show="getPendingItems().length === 0" class="flex flex-col items-center justify-center h-full text-slate-400 p-8">
                        <i class="fas fa-check-circle text-4xl text-slate-200 mb-2"></i>
                        <span class="text-xs font-bold">Semua paket tanggal ini sudah diproses.</span>
                    </div>
                </div>
                <div class="p-4 bg-white border-t border-slate-200 shrink-0 flex justify-between items-center">
                    <span class="text-xs font-bold text-slate-500">Terpilih: <span class="text-rose-600 text-lg" x-text="selectedManifestItems.length"></span></span>
                    <button @click="createManifest()" :disabled="selectedManifestItems.length === 0" class="bg-rose-600 hover:bg-rose-700 disabled:bg-slate-300 text-white px-6 py-3 rounded-xl font-bold text-xs shadow-lg shadow-rose-500/30 transition-all flex items-center gap-2"><i class="fas fa-print"></i> PROSES & PRINT</button>
                </div>
            </div>
             <div x-show="manifestTab === 'history'" class="flex-1 flex flex-col overflow-hidden bg-slate-50">
                <div class="flex-1 overflow-y-auto p-4 space-y-3">
                    <div x-show="isLoading" class="text-center py-4 text-xs font-bold text-slate-400 animate-pulse">Memuat riwayat...</div>
                    <template x-for="hist in manifestHistory.slice().reverse()" :key="hist.id">
                        <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs font-extrabold text-slate-800 uppercase" x-text="hist.courier === 'ALL' ? 'SEMUA EKSPEDISI' : hist.courier"></span>
                                        <span class="text-[9px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded font-mono" x-text="hist.itemCount + ' Paket'"></span>
                                    </div>
                                    <p class="text-[10px] text-slate-400 mt-1" x-text="new Date(hist.timestamp).toLocaleString('id-ID')"></p>
                                </div>
                                <div class="flex gap-2">
                                    <button @click="reprintManifest(hist)" class="bg-blue-50 hover:bg-blue-100 text-blue-600 px-3 py-1.5 rounded-lg text-[10px] font-bold border border-blue-100 transition-all"><i class="fas fa-print mr-1"></i> REPRINT</button>
                                    <button @click="deleteManifest(hist)" class="bg-red-50 hover:bg-red-100 text-red-600 w-8 rounded-lg border border-red-100 flex items-center justify-center transition-all shadow-sm"><i class="fas fa-trash-alt text-xs"></i></button>
                                </div>
                            </div>
                            <div class="text-[10px] text-slate-500 bg-slate-50 p-2 rounded font-mono break-all whitespace-normal border border-slate-100 leading-relaxed" x-text="hist.items.join(', ')"></div>
                        </div>
                    </template>
                    <div x-show="!isLoading && manifestHistory.length === 0" class="text-center p-8 text-slate-400 text-xs italic">Belum ada riwayat manifest.</div>
                </div>
             </div>
        </div>
    </div>

    <div x-show="showDeleteModal" class="fixed inset-0 bg-slate-900/80 z-[100] flex items-center justify-center p-4 backdrop-blur-sm" x-cloak x-transition.opacity>
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-6 text-center modal-enter">
            <h3 class="text-lg font-bold text-slate-800 mb-1">Hapus Data?</h3>
            <button @click="deleteOnlineData('today')" class="w-full bg-red-600 hover:bg-red-700 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-red-500/20 mb-3 flex items-center justify-center gap-2"><i class="fas fa-calendar-day"></i> HAPUS HARI INI</button>
            <button @click="deleteOnlineData('all')" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 py-3.5 rounded-xl font-bold shadow-sm mb-4 flex items-center justify-center gap-2"><i class="fas fa-dumpster"></i> RESET SEMUA</button>
            <button @click="showDeleteModal = false" class="text-slate-400 text-xs font-bold hover:text-slate-600">BATALKAN</button>
        </div>
    </div>

    <div x-show="showQrModal" class="fixed inset-0 bg-slate-900/80 z-[100] flex items-center justify-center p-4 backdrop-blur-sm" x-cloak x-transition.opacity>
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-8 text-center modal-enter relative">
            <button @click="showQrModal = false" class="absolute top-4 right-4 text-slate-400 hover:text-rose-500"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-lg font-bold text-slate-800 mb-4">Scan untuk Login</h3>
            <div class="bg-white p-2 rounded-xl border border-slate-100 inline-block shadow-sm mb-4">
                <img :src="'https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=' + encodeURIComponent(window.location.href)" alt="QR Code Login" class="w-48 h-48">
            </div>
            <p class="text-xs text-slate-500">Arahkan kamera HP lain ke QR ini untuk membuka aplikasi langsung.</p>
        </div>
    </div>

    <div x-show="showWarningModal" class="fixed inset-0 bg-red-900/80 z-[110] flex items-center justify-center p-4 backdrop-blur-sm" x-cloak x-transition.opacity>
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-6 text-center modal-enter border-4 border-red-500">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600 text-3xl animate-bounce"><i class="fas fa-exclamation-triangle"></i></div>
            <h3 class="text-xl font-extrabold text-red-600 mb-2">PERINGATAN!</h3>
            <p class="text-sm text-gray-600 mb-4 font-bold" x-text="warningMessage"></p>
            <div class="flex gap-2">
                <button @click="showWarningModal = false; barcodeInput = ''" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 rounded-xl font-bold">BATAL</button>
                <button @click="processConfirmedScan()" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-bold shadow-lg">TETAP SIMPAN</button>
            </div>
        </div>
    </div>

    <audio id="beepSuccess" src="https://www.soundjay.com/button/beep-07.wav"></audio>
    <audio id="beepError" src="https://www.soundjay.com/button/beep-10.wav"></audio>

    <script>
        function dragScroll() {
            return {
                isDown: false, startX: 0, scrollLeft: 0, isDragging: false,
                start(e) { this.isDown = true; this.isDragging = false; this.startX = e.pageX - this.$el.offsetLeft; this.scrollLeft = this.$el.scrollLeft; this.$el.classList.add('cursor-grabbing'); this.$el.classList.remove('cursor-grab'); },
                stop() { this.isDown = false; this.$el.classList.remove('cursor-grabbing'); this.$el.classList.add('cursor-grab'); setTimeout(() => this.isDragging = false, 50); },
                move(e) { if(!this.isDown) return; e.preventDefault(); this.isDragging = true; const x = e.pageX - this.$el.offsetLeft; const walk = (x - this.startX) * 2; this.$el.scrollLeft = this.scrollLeft - walk; }
            }
        }

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playBeep(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            if (type === 'success') { osc.type = 'sine'; osc.frequency.setValueAtTime(1200, audioCtx.currentTime); gain.gain.setValueAtTime(0.1, audioCtx.currentTime); osc.start(); osc.stop(audioCtx.currentTime + 0.1); } 
            else { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, audioCtx.currentTime); gain.gain.setValueAtTime(0.2, audioCtx.currentTime); osc.start(); osc.stop(audioCtx.currentTime + 0.3); }
        }

        function appData() {
            return {
                apiUrl: 'https://script.google.com/macros/s/AKfycby4x62FVm-YYKq7K_pTuZVI0MYjnVC6419ueNVZc95jNOzKQSrTxFAHvpUHCDJbCWfFFA/exec',
                isLoggedIn: sessionStorage.getItem('autokirim_session') === 'true',
                selectedUser: sessionStorage.getItem('autokirim_user') || '',
                loginPass: '', isLoading: false, loadingText: 'Menghubungkan...',
                onlineData: [],
                
                showQrModal: false, isBatchMode: false, batchQueue: [], showWarningModal: false, warningMessage: '', pendingScanCode: null, selectedRows: [],
                pcLinkEnabled: localStorage.getItem('pcLinkEnabled') === 'true', pcIpAddress: localStorage.getItem('pcIpAddress') || '',

                couriers: ['J&T Express', 'JNE Express', 'ID Express', 'Sicepat', 'SPX', 'Lazada Lex', 'Anteraja', 'Ninja', 'J&T Cargo','Lion Parcel (Reg Pack)','Lion Parcel (Jago Pack)', 'SAPX', 'Sentral Cargo', 'Paxel', 'POS Aja'],
                marketplaces: [{name:'Shopee',icon:'fa-shopping-bag'},{name:'Tokopedia',icon:'fa-store'},{name:'Lazada',icon:'fa-heart'},{name:'TikTok',icon:'fa-music'},{name:'Manual',icon:'fa-pen'}],
                selectedCourier: 'JNT Express', selectedMp: 'Shopee', barcodeInput: '', 
                isCameraActive: false, html5QrCode: null, showDetailModal: false, showDeleteModal: false, tempItem: {}, scanStatus: 'idle',
                isCODInput: true, searchQuery: '', activeFilter: 'ALL', isEditMode: false, currentView: 'home',
                filterDate: new Date().toLocaleDateString('en-CA'), hasOldData: false,
                courierChart: null, paymentChart: null,

                showManifestManager: false,
                manifestTab: 'new',
                manifestCourier: 'ALL',
                manifestFilterDate: new Date().toLocaleDateString('en-CA'),
                manifestStartTime: '00:00',
                manifestEndTime: '23:59',
                manifestHistory: [], 
                processedResis: [],
                selectedManifestItems: [],

                commissionRates: { 'J&T Express': 0.25,'J&T Cargo': 0.25, 'JNE Express': 0.15, 'ID Express': 0.25, 'Sicepat': 0.20, 'SPX': 0.20, 'Paxel': 0.07, 'Lion Parcel (Reg Pack)': 0.15, 'Lion Parcel (Jago Pack)': 0.05, 'Ninja': 0.20, 'Pos Aja': 0.07, 'Anteraja': 0.30, 'Lazada Lex': 0.20, 'SAPX': 0.25, 'Default': 0.10 },

                initApp() { 
                    this.filterDate = this.getJakartaDateISO();
                    this.manifestFilterDate = this.getJakartaDateISO();
                    if(this.isLoggedIn) { this.refreshData(); this.checkAllOldData(); this.fetchManifestHistory(); }
                    this.$watch('pcLinkEnabled', val => localStorage.setItem('pcLinkEnabled', val));
                    this.$watch('pcIpAddress', val => localStorage.setItem('pcIpAddress', val));
                },
                
                getJakartaDateISO() { return new Intl.DateTimeFormat('en-CA', { timeZone: 'Asia/Jakarta', year: 'numeric', month: '2-digit', day: '2-digit' }).format(new Date()); },
                checkAllOldData() { const keys = ['autokirimV18', 'autokirimV25', 'autokirimV27', 'autokirimV28', 'autokirimV30', 'autokirimV31', 'autokirimV32']; this.hasOldData = keys.some(k => { const d = localStorage.getItem(k); return d && JSON.parse(d).length > 0; }); },
                async migrateAllData() { /* Migration Logic */ },
                
                async doLogin() {
                    if(!this.selectedUser) return alert("Pilih user dulu!");
                    this.isLoading = true;
                    try {
                        const res = await fetch(this.apiUrl, { method: 'POST', body: JSON.stringify({ action: 'login', user: this.selectedUser, pass: this.loginPass }) });
                        const r = await res.json();
                        if(r.status === 'success') {
                             this.isLoggedIn = true; sessionStorage.setItem('autokirim_session', 'true'); sessionStorage.setItem('autokirim_user', this.selectedUser); this.refreshData(); this.fetchManifestHistory();
                        } else {
                             // Fallback
                             const fallbackCreds = { 'Admin': 'admin12', 'Erika': 'erika123', 'Karyawan 1': '12345', 'Karyawan 2': '12345' };
                             if(fallbackCreds[this.selectedUser] && fallbackCreds[this.selectedUser] === this.loginPass) {
                                this.isLoggedIn = true; sessionStorage.setItem('autokirim_session', 'true'); sessionStorage.setItem('autokirim_user', this.selectedUser); this.refreshData(); this.fetchManifestHistory();
                             } else { alert("Password Salah!"); this.loginPass = ''; }
                        }
                    } catch(e) {
                         const fallbackCreds = { 'Admin': 'admin12', 'Erika': 'erika123', 'Karyawan 1': '12345', 'Karyawan 2': '12345' };
                         if(fallbackCreds[this.selectedUser] && fallbackCreds[this.selectedUser] === this.loginPass) {
                            this.isLoggedIn = true; sessionStorage.setItem('autokirim_session', 'true'); sessionStorage.setItem('autokirim_user', this.selectedUser); this.refreshData(); this.fetchManifestHistory();
                         } else { alert("Gagal Login: Cek Internet/Server"); }
                    }
                    this.isLoading = false;
                },
                logout() { if(confirm('Keluar?')) { this.isLoggedIn = false; sessionStorage.removeItem('autokirim_session'); sessionStorage.removeItem('autokirim_user'); } },

                fixDateFromDB(dateStr) {
                    if(!dateStr) return '';
                    if(dateStr.includes('T')) {
                        const d = new Date(dateStr);
                        return new Intl.DateTimeFormat('en-CA', { timeZone: 'Asia/Jakarta', year: 'numeric', month: '2-digit', day: '2-digit' }).format(d);
                    }
                    return dateStr.substring(0, 10);
                },

                async refreshData() {
                    if (!this.apiUrl) return; this.isLoading = true;
                    try {
                        const res = await fetch(this.apiUrl, { method: 'POST', body: JSON.stringify({ action: 'get' }) });
                        if(res.ok) {
                            const data = await res.json();
                            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                            this.onlineData = data.map(item => {
                                if(item.date) item.date = this.fixDateFromDB(item.date);
                                if(item.date) {
                                    const parts = item.date.split('-');
                                    const d = new Date(parts[0], parts[1]-1, parts[2]);
                                    item.dayName = days[d.getDay()];
                                }
                                return item;
                            }).reverse(); 
                            if(this.currentView === 'dashboard') this.updateCharts();
                        }
                    } catch (e) { console.error(e); } this.isLoading = false;
                },
                
                async fetchManifestHistory() {
                   try {
                       const res = await fetch(this.apiUrl, { method: 'POST', body: JSON.stringify({ action: 'get_manifest' }) });
                       if(res.ok) {
                           const r = await res.json();
                           if(r.status === 'success') {
                               this.manifestHistory = r.data;
                               let processed = [];
                               this.manifestHistory.forEach(h => { processed = [...processed, ...h.items]; });
                               this.processedResis = processed;
                           }
                       }
                   } catch(e) { console.log('Manifest Fetch Error', e); }
                },

                // PHOTO LOGIC
                processPhoto(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    // Compress Image using Canvas
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // Max Width 800px (Balance quality vs upload speed)
                            const MAX_WIDTH = 800;
                            let width = img.width;
                            let height = img.height;
                            
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // To Base64 (JPEG quality 0.7)
                            this.tempItem.photoBase64 = canvas.toDataURL('image/jpeg', 0.7);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                },

                async deleteOnlineData(type) { 
                    const dateTarget = this.filterDate;
                    if (!confirm(type === 'all' ? "YAKIN HAPUS SEMUA?" : `Hapus data tanggal ${this.formatDateID(dateTarget)}?`)) return;
                    this.showDeleteModal = false; this.isLoading = true; this.loadingText = "Menghapus...";
                    try { const res = await fetch(this.apiUrl, { method: 'POST', body: JSON.stringify({ action: 'delete', type: type, date: dateTarget }) }); const r = await res.json(); if (r.status === 'success') { alert(r.message); this.refreshData(); } else { alert(r.message); } } catch (e) { alert("Error: " + e); } this.isLoading = false;
                },

                async saveData() {
                    this.showDetailModal = false; 
                    this.isLoading = true;
                    this.loadingText = this.isEditMode ? 'Mengupdate Data...' : 'Menyimpan (Upload Foto)...'; // Text Update
                    this.tempItem.admin = this.selectedUser;
                    
                    const rate = this.commissionRates[this.tempItem.courier] || this.commissionRates['Default'];
                    this.tempItem.profit = Math.round((parseInt(this.tempItem.price) || 0) * rate);

                    let cleanMarketplace = this.tempItem.marketplace;
                    cleanMarketplace = cleanMarketplace.replace(/ \((Pick Up|Drop Off)\)/g, "");

                    if(this.tempItem.method) {
                        this.tempItem.marketplace = cleanMarketplace + " (" + this.tempItem.method + ")";
                    } else {
                        this.tempItem.marketplace = cleanMarketplace;
                    }

                    try { const res = await fetch(this.apiUrl, { method: 'POST', body: JSON.stringify({ action: this.isEditMode ? 'edit' : 'add', data: this.tempItem }) }); const r = await res.json(); if (r.status === 'success') { this.triggerFeedback('success'); await this.refreshData(); } else { alert(r.message); } } catch (e) { alert("Error: " + e); }
                    this.isLoading = false; 
                    if(!this.isCameraActive) document.getElementById('barcodeInput').focus();
                },
                
                openEditModal(item) { 
                    this.isEditMode = true; 
                    this.tempItem = JSON.parse(JSON.stringify(item)); 
                    this.tempItem.originalCode = item.code; 
                    this.tempItem.photoBase64 = null; // Reset temp photo on edit open
                    
                    if(this.tempItem.marketplace.includes('(Pick Up)')) {
                        this.tempItem.method = 'Pick Up';
                        this.tempItem.marketplace = this.tempItem.marketplace.replace(' (Pick Up)', '');
                    } else if(this.tempItem.marketplace.includes('(Drop Off)')) {
                        this.tempItem.method = 'Drop Off';
                        this.tempItem.marketplace = this.tempItem.marketplace.replace(' (Drop Off)', '');
                    } else {
                        this.tempItem.method = 'Pick Up';
                    }
                    
                    this.showDetailModal = true; 
                },

                async saveBatch() {
                    if (this.batchQueue.length === 0) return;
                    this.isLoading = true; let successCount = 0;
                    for (let i = 0; i < this.batchQueue.length; i++) {
                        const item = this.batchQueue[i];
                        const rate = this.commissionRates[item.courier] || this.commissionRates['Default'];
                        item.profit = Math.round((parseInt(item.price) || 0) * rate);
                        this.loadingText = `Menyimpan ${i + 1} / ${this.batchQueue.length}...`;
                        try { await fetch(this.apiUrl, { method: 'POST', body: JSON.stringify({ action: 'add', data: item }) }); successCount++; } catch (e) { console.error(e); }
                    }
                    this.isLoading = false; this.batchQueue = []; alert(`${successCount} Paket berhasil disimpan!`); this.refreshData();
                },

                get filteredData() {
                    let data = this.onlineData;
                    if (this.filterDate) data = data.filter(i => i.date === this.filterDate);
                    if (this.searchQuery) { const q = this.searchQuery.toLowerCase(); data = data.filter(i => String(i.code).toLowerCase().includes(q) || String(i.receiver).toLowerCase().includes(q)); }
                    if (this.activeFilter !== 'ALL') data = data.filter(i => i.courier === this.activeFilter);
                    return data;
                },

                get totalCOD() { return this.filteredData.filter(i => i.isCOD).reduce((acc, curr) => acc + (parseInt(curr.price) || 0), 0); },
                get totalNonCOD() { return this.filteredData.filter(i => !i.isCOD).reduce((acc, curr) => acc + (parseInt(curr.price) || 0), 0); },
                get totalProfit() { return this.filteredData.reduce((acc, curr) => acc + (parseInt(curr.profit) || 0), 0); },
                get scanStatusClass() { return this.scanStatus === 'success' ? 'flash-success' : (this.scanStatus === 'error' ? 'flash-error' : ''); },
                getMpColor(mp) { return {'Shopee':'bg-orange-500','Tokopedia':'bg-green-500','Lazada':'bg-blue-600'}[mp] || 'bg-slate-400'; },
                getCourierColor(c) {
                    if(c.includes('JNT')) return 'border-red-600';
                    if(c.includes('JNE') || c.includes('ID')) return 'border-blue-600';
                    if(c.includes('SPX') || c.includes('Shopee')) return 'border-orange-500';
                    if(c.includes('Sicepat')) return 'border-purple-600';
                    if(c.includes('Lazada')) return 'border-blue-400';
                    if(c.includes('Anteraja')) return 'border-pink-500';
                    return 'border-gray-300';
                },

                formatRupiah(num) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num || 0); },
                formatDateID(dateString) { 
                    if(!dateString) return '-'; 
                    const parts = dateString.split('-');
                    if(parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0]}`;
                    return dateString; 
                },
                getTodayISO() { return this.getJakartaDateISO(); },
                toggleAll(e) { if (e.target.checked) { this.selectedRows = this.filteredData.map(item => item.code); } else { this.selectedRows = []; } },

                async deleteSelected() {
                    if(!confirm(`Hapus ${this.selectedRows.length} item terpilih?`)) return;
                    this.isLoading = true; this.loadingText = "Menghapus item...";
                    try { const res = await fetch(this.apiUrl, { method: 'POST', body: JSON.stringify({ action: 'delete_list', codes: this.selectedRows }) }); const r = await res.json(); alert(r.message); this.selectedRows = []; this.refreshData(); } catch(e) { alert("Gagal menghapus."); }
                    this.isLoading = false;
                },

                validateCourier(code, courier) {
                    const c = courier.toUpperCase(); const r = code.toUpperCase();
                    if (c.includes('JNT') && !r.startsWith('J') && !r.startsWith('JO') && !r.startsWith('JP')) return false;
                    if (c.includes('SPX') && !r.startsWith('SPX') && !r.startsWith('ID')) return false;
                    if (c.includes('JNE') && !r.startsWith('JNE') && isNaN(r.charAt(0))) return false; 
                    return true;
                },

                preProcessScan(codeFromCamera = null) {
                    let code = codeFromCamera || this.barcodeInput.trim(); code = code.toUpperCase().replace(/\s+/g, ''); if(!code) return;
                    if(this.onlineData.some(i => i.code === code) || this.batchQueue.some(i => i.code === code)) { this.triggerFeedback('error'); alert('Resi SUDAH ADA!'); if(!codeFromCamera) this.barcodeInput=''; return; }
                    if (!this.validateCourier(code, this.selectedCourier)) { this.triggerFeedback('error'); this.warningMessage = `Resi "${code}" sepertinya bukan milik ${this.selectedCourier}. Yakin ingin simpan?`; this.pendingScanCode = code; this.showWarningModal = true; return; }
                    this.executeScan(code);
                },

                processConfirmedScan() { this.showWarningModal = false; this.executeScan(this.pendingScanCode); },

                executeScan(code) {
                    this.triggerFeedback('success');
                    let finalCourier = this.selectedCourier;
                    let currentIsCOD = (this.selectedMp === 'Manual') ? this.isCODInput : true;
                    let defaultPrice = (this.selectedMp === 'Manual' && !currentIsCOD) ? 0 : 0;
                    const dateStr = this.getJakartaDateISO();
                    const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                    const d = new Date();
                    const dayName = days[d.getDay()];
                    const fullTime = d.toLocaleTimeString('id-ID', {hour12: false});
                    const method = 'Pick Up'; 
                    const newItem = { code: code, courier: finalCourier, marketplace: this.selectedMp, isCOD: currentIsCOD, receiver: '', destination: '', weight: '', price: defaultPrice, time: fullTime, date: dateStr, dayName: dayName, admin: this.selectedUser, method: method };

                    if(this.isBatchMode) { this.batchQueue.push(newItem); if(!this.isCameraActive) this.barcodeInput = ''; return; }
                    if (this.pcLinkEnabled && this.pcIpAddress) { fetch(`http://${this.pcIpAddress}:5000/scan`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code: code }), mode: 'no-cors' }).catch(err => console.log(err)); }

                    this.isEditMode = false; this.tempItem = newItem;
                    setTimeout(() => { this.showDetailModal = true; setTimeout(() => document.getElementById('receiverInput')?.focus(), 100); this.barcodeInput = ''; }, 300);
                },
                
                triggerFeedback(type) { this.scanStatus = type; playBeep(type); setTimeout(() => this.scanStatus = 'idle', 800); },
                
                toggleCamera() { 
                    if(this.isCameraActive) { 
                        if(this.html5QrCode) this.html5QrCode.stop().then(()=>{ this.html5QrCode.clear(); this.isCameraActive = false; }); 
                    } else { 
                        if (audioCtx.state === 'suspended') audioCtx.resume();
                        this.isCameraActive = true; 
                        this.$nextTick(()=>{ 
                            if(!navigator.mediaDevices) return alert("No Camera"); 
                            const cfg={fps:10, qrbox:{width:320, height:150}, aspectRatio: 1.7}; 
                            if(!this.html5QrCode) this.html5QrCode=new Html5Qrcode("reader"); 
                            this.html5QrCode.start({facingMode:"environment"},cfg,(t)=>{if(!this.showDetailModal && this.scanStatus==='idle') this.preProcessScan(t)}).catch(e=>{alert(e);this.isCameraActive=false;}); 
                        }); 
                    } 
                },
                getSummary() { const c={}; this.filteredData.forEach(i=>{c[i.courier]=(c[i.courier]||0)+1}); return c; },
                
                exportExcel() {
                    const d = this.filteredData; if(d.length===0) return alert("Kosong");
                    let c="Tanggal,Hari,Jam,Ekspedisi,Resi,Penerima,Tujuan,Status,Nominal,Admin,Profit,Foto\n";
                    d.forEach(r=>{c+=`${this.formatDateID(r.date)},${r.dayName||'-'},${r.time},${r.courier},${r.code},"${r.receiver}","${r.destination}",${r.isCOD?'COD':'NON'},${r.price},${r.admin||''},${r.profit||0},${r.photoUrl||''}\n`});
                    const l=document.createElement("a"); l.href="data:text/csv;charset=utf-8,"+encodeURI(c); l.download=`Laporan_${this.filterDate}.csv`; document.body.appendChild(l); l.click(); l.remove();
                },

                // MANIFEST LOGIC UPDATED
                openManifestManager() { if (this.activeFilter !== 'ALL') this.manifestCourier = this.activeFilter; this.manifestTab = 'new'; this.showManifestManager = true; this.selectedManifestItems = []; },
                isPrinted(code) { return this.processedResis.includes(code); },
                
                getPendingItems() {
                    return this.onlineData.filter(i => {
                        if (i.date !== this.manifestFilterDate) return false;
                        if (this.manifestCourier !== 'ALL' && i.courier !== this.manifestCourier) return false;
                        if (i.time < (this.manifestStartTime || '00:00')) return false;
                        if (i.time > (this.manifestEndTime || '23:59')) return false;
                        if (this.isPrinted(i.code)) return false;
                        return true;
                    });
                },
                toggleManifestItem(code) { if (this.selectedManifestItems.includes(code)) { this.selectedManifestItems = this.selectedManifestItems.filter(c => c !== code); } else { this.selectedManifestItems.push(code); } },
                selectAllManifestItems() { const items = this.getPendingItems(); if (this.selectedManifestItems.length === items.length) { this.selectedManifestItems = []; } else { this.selectedManifestItems = items.map(i => i.code); } },
                
                async createManifest() {
                    if (this.selectedManifestItems.length === 0) return;
                    const itemsToPrint = this.onlineData.filter(i => this.selectedManifestItems.includes(i.code));
                    const historyEntry = { id: Date.now(), courier: this.manifestCourier, timestamp: new Date().toISOString(), items: this.selectedManifestItems, itemCount: this.selectedManifestItems.length };
                    this.isLoading = true; this.loadingText = "Menyimpan Manifest...";
                    try { await fetch(this.apiUrl, { method: 'POST', body: JSON.stringify({ action: 'save_manifest', data: historyEntry }) }); this.manifestHistory.push(historyEntry); this.processedResis = [...this.processedResis, ...this.selectedManifestItems]; const printTitle = this.manifestCourier === 'ALL' ? 'SEMUA EKSPEDISI' : this.manifestCourier; this.printManifestHTML(itemsToPrint, printTitle); this.selectedManifestItems = []; this.manifestTab = 'history'; } catch(e) { alert("Gagal menyimpan ke database."); }
                    this.isLoading = false;
                },
                reprintManifest(hist) { const itemsToPrint = this.onlineData.filter(i => hist.items.includes(i.code)); const printTitle = hist.courier === 'ALL' ? 'SEMUA EKSPEDISI' : hist.courier; this.printManifestHTML(itemsToPrint, printTitle); },
                async deleteManifest(hist) {
                    if(!confirm('Hapus riwayat manifest ini?')) return; this.isLoading = true;
                    try { const res = await fetch(this.apiUrl, { method: 'POST', body: JSON.stringify({ action: 'delete_manifest', id: hist.id }) }); const r = await res.json(); if(r.status === 'success') { this.manifestHistory = this.manifestHistory.filter(h => h.id !== hist.id); let newProcessed = []; this.manifestHistory.forEach(h => { newProcessed = [...newProcessed, ...h.items]; }); this.processedResis = newProcessed; alert('Manifest dihapus.'); } } catch(e) { alert('Error koneksi.'); }
                    this.isLoading = false;
                },
                printManifestHTML(data, cn) {
                    if(data.length===0) return alert("Data tidak ditemukan."); const tQ=data.length; const timeP = new Date().toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }); const w=window.open('','_blank');
                    w.document.write(`<html><head><title>Manifest ${cn}</title><style>body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;padding:10px;font-size:12px;color:#333;width:100%;box-sizing:border-box}.company-header{text-align:center;margin-bottom:10px}.company-name{font-size:16px;font-weight:bold;margin-bottom:2px;text-transform:uppercase;color:#000}.company-address{font-size:12px;color:#000;margin-bottom:1px}.report-title{text-align:center;margin:10px 0;border-top:2px solid #000;border-bottom:2px solid #000;padding:5px 0}.report-title h2{margin:0;font-size:14px;text-transform:uppercase;letter-spacing:1px}.report-title h3{margin:2px 0 0;font-size:16px;color:#000;font-weight:800}.meta-info{display:flex;justify-content:space-between;margin-bottom:15px;font-weight:bold;font-size:12px}table{width:100%;border-collapse:collapse;margin-bottom:20px}th,td{border:1px solid #000;padding:4px;text-align:left}th{background-color:#f3f4f6;text-transform:uppercase;font-size:11px;font-weight:700;color:#000}td{font-size:12px}.resi-col{font-size:15px;font-weight:900;font-family:monospace}.footer{display:flex;justify-content:space-between;margin-top:30px;gap:10px}.sign-box{text-align:center;width:45%}.sign-line{margin-top:50px;border-top:1px solid #000;padding-top:5px;font-size:11px;font-weight:bold;width:100%}.printed-by{text-align:center;font-size:11px;margin-top:20px;font-style:italic;color:#555}</style></head><body><div class="company-header"><div class="company-name">AUTOKIRIM TELUK GONG 2</div><div class="company-address">Jl. Teluk Gong Raya 3 RT.08/RW.10</div><div class="company-address">No Telp. 085760035568</div><div class="pos-id">Pickup POS : AK00031858</div></div><div class="report-title"><h2>PICKUP MANIFEST</h2><h3>${cn.toUpperCase()}</h3></div><div class="meta-info"><div>${timeP}</div><div>Total: ${tQ}</div></div><table><thead><tr><th style="width: 5%; text-align:center;">No</th><th style="width: 35%">No. Resi</th><th style="width: 30%">Nama Penerima</th><th style="width: 15%">Market</th><th style="width: 15%">Tipe</th></tr></thead><tbody>${data.map((item, index) => `<tr><td style="text-align:center">${index + 1}</td><td class="resi-col">${item.code}<br><span style="font-size:9px; color:#555;">${item.courier}</span></td><td>${item.receiver || '-'}</td><td>${item.marketplace}</td><td>${item.isCOD ? 'COD' : '(NON COD)'}</td></tr>`).join('')}</tbody></table><div class="footer"><div class="sign-box"><p style="margin-bottom: 5px; font-size: 11px;">Admin / Sender</p><div class="sign-line">( Tanda Tangan )</div></div><div class="sign-box"><p style="margin-bottom: 5px; font-size: 11px;">Kurir / Driver</p><div class="sign-line">( Tanda Tangan )</div></div></div><div class="printed-by">Printed by : ${this.selectedUser}</div><script>setTimeout(function(){ window.print(); }, 1000);</sc` + `ript></body></html>`);
                    w.document.close();
                },

                printStruk(i) {
                    const w = window.open('', '_blank', 'width=350,height=500'); const date = this.formatDateID(i.date);
                    const html = `<!DOCTYPE html><html><head><title>Struk-${i.code}</title><style>body{margin:0;padding:10px;font-family:'Courier New',monospace;font-size:12px;width:58mm;color:#000}.center{text-align:center}.bold{font-weight:bold}.line{border-top:1px dashed #000;margin:8px 0}.row{display:flex;justify-content:space-between}.big{font-size:16px;font-weight:800}</style></head><body><div class="center bold">AUTOKIRIM TELUK GONG 2</div><div class="center">Jl. Teluk Gong Raya 3 RT.08/RW.10</div><div class="center">Pejagalan, Kec. Penjaringan, Jakarta Utara</div><div class="center">No Telp. 085760035568</div><div class="center bold" style="margin-bottom:5px">Pickup POS : AK00031858</div><div class="line"></div><div class="center bold">BUKTI TANDA TERIMA</div><div class="center">${date} ${i.time}</div><div class="line"></div><div class="center big">${i.courier}</div><div class="center bold" style="margin:5px 0">${i.code}</div><div class="line"></div><div class="row"><span>Tipe:</span><span class="bold">${i.isCOD ? 'COD' : 'NON-COD'}</span></div><div class="row"><span>Ongkir:</span><span class="bold">${this.formatRupiah(i.price)}</span></div><div class="line"></div><div class="bold">Penerima:</div><div>${i.receiver || '-'}</div><div class="bold" style="margin-top:4px">Tujuan:</div><div>${i.destination || '-'}</div><div class="line"></div><div class="center" style="font-size:10px;">Simpan struk ini sebagai bukti.</div><script>setTimeout(function(){ window.print(); }, 1000);</sc`+`ript></body></html>`;
                    w.document.write(html); w.document.close();
                },
                
                shareToWA() {
                    if(this.filteredData.length===0) return alert("Kosong");
                    let t = `*LAPORAN AUTOKIRIM*\nTgl: ${this.formatDateID(this.filterDate)}\nTotal: ${this.filteredData.length}\nCOD: ${this.formatRupiah(this.totalCOD)}\nNON: ${this.formatRupiah(this.totalNonCOD)}\n\n`;
                    const s = this.getSummary(); for(const [k,v] of Object.entries(s)) t+=`- ${k}: ${v}\n`;
                    window.open(`https://wa.me/?text=${encodeURIComponent(t)}`,'_blank');
                },
                toggleView() { this.currentView = this.currentView==='home'?'dashboard':'home'; if(this.currentView==='dashboard') this.$nextTick(()=>this.initCharts()); },
                getAdminStats() { const s={}; this.filteredData.forEach(i=>{const a=i.admin||'Unknown'; s[a]=(s[a]||0)+1;}); return s; },
                initCharts() { this.updateCharts(); },
                updateCharts() {
                    if(this.currentView!=='dashboard') return;
                    const s = this.getSummary();
                    if(this.courierChart) this.courierChart.destroy(); if(this.paymentChart) this.paymentChart.destroy();
                    const ctx1 = document.getElementById('courierChart'); if(ctx1) { this.courierChart = new Chart(ctx1, { type: 'doughnut', data: { labels: Object.keys(s), datasets: [{ data: Object.values(s), backgroundColor: ['#ef4444','#f97316','#22c55e','#3b82f6','#a855f7','#ec4899','#64748b'], borderWidth: 0, hoverOffset: 15 }] }, options: { maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: { family: 'Plus Jakarta Sans', size: 10 } } } } } }); }
                    const c = this.filteredData.filter(i=>i.isCOD).length; const n = this.filteredData.length - c;
                    const ctx2 = document.getElementById('paymentChart'); if(ctx2) { this.paymentChart = new Chart(ctx2, { type: 'bar', data: { labels: ['COD','Non-COD'], datasets: [{ label: 'Total Paket', data: [c,n], backgroundColor: ['#22c55e','#3b82f6'], borderRadius: 12, barThickness: 60 }] }, options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { borderDash: [5, 5] } }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } } }); }
                }
            }
        }
    </script>
</body>
</html>
