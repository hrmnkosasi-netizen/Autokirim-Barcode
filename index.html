<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Autokirim V51 (Manifest Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        [x-cloak] { display: none !important; }
        #reader { width: 100%; height: 100%; background: #000; border-radius: 12px; overflow: hidden; }
        #reader video { width: 100% !important; height: 100% !important; object-fit: cover !important; }
        .scan-overlay { position: absolute; inset: 0; pointer-events: none; z-index: 10; display: flex; align-items: center; justify-content: center; }
        .scan-box { width: 70%; height: 60%; border-radius: 16px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.7); border: 2px solid rgba(255,255,255,0.3); position: relative; transition: all 0.2s; }
        .laser { position: absolute; left: 5%; width: 90%; height: 2px; background: #ef4444; box-shadow: 0 0 10px #ef4444; top: 50%; animation: laserAnim 2s infinite ease-in-out; }
        @keyframes laserAnim { 0% { transform: translateY(-40px); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateY(40px); opacity: 0; } }
        .flash-success .scan-box { border: 6px solid #22c55e !important; }
        .flash-error .scan-box { border: 6px solid #dc2626 !important; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 110; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .modal-enter { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .disabled-zone { opacity: 0.5; filter: grayscale(100%); pointer-events: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col min-h-screen md:h-screen md:overflow-hidden" x-data="appData()" x-init="initApp()">

    <div x-show="isLoading" class="loading-overlay" x-transition>
        <div class="flex flex-col items-center text-center p-6">
            <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-red-600 mb-3"></div>
            <p class="text-xs font-bold text-red-600 animate-pulse" x-text="loadingText"></p>
        </div>
    </div>

    <div x-show="!isLoggedIn" class="fixed inset-0 z-[100] bg-gradient-to-br from-red-900 to-gray-900 flex items-center justify-center p-4" x-transition.opacity>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-8 text-center modal-enter">
            <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600 shadow-inner"><i class="fas fa-users text-3xl"></i></div>
            <h1 class="text-2xl font-extrabold text-gray-800 mb-1">AUTOKIRIM V51</h1>
            <p class="text-sm text-gray-500 mb-6">Manifest Fixed</p>
            <form @submit.prevent="doLogin">
                <div class="mb-3 text-left">
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Pilih User</label>
                    <select x-model="selectedUser" class="w-full bg-gray-50 border-2 border-gray-200 p-3 rounded-xl font-bold text-gray-700 outline-none focus:border-red-500">
                        <option value="" disabled>-- Pilih Nama --</option>
                        <option value="Admin">Admin Utama</option>
                        <option value="Karyawan 1">Karyawan 1</option>
                        <option value="Karyawan 2">Karyawan 2</option>
                        <option value="Karyawan 3">Karyawan 3</option>
                    </select>
                </div>
                <input type="password" x-model="loginPass" class="w-full bg-gray-50 border-2 border-gray-200 p-3 rounded-xl font-bold text-center text-lg outline-none focus:border-red-500 mb-4" placeholder="Password" autofocus>
                <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-bold shadow-lg">MASUK SISTEM</button>
            </form>
        </div>
    </div>

    <div x-show="isLoggedIn" class="flex flex-col md:flex-row w-full md:h-full" x-cloak>
        <header class="md:hidden bg-red-700 text-white p-3 shadow-md flex justify-between items-center z-30 relative shrink-0">
            <div class="flex items-center gap-2">
                <i class="fas fa-cloud text-yellow-400"></i>
                <div><h1 class="font-bold text-sm">AUTOKIRIM</h1><p class="text-[9px] opacity-80" x-text="'User: ' + selectedUser"></p></div>
            </div>
            <div class="flex gap-2">
                <button @click="toggleView()" class="text-xs bg-red-800 px-3 py-1 rounded border border-red-500"><i class="fas" :class="currentView === 'home' ? 'fa-chart-pie' : 'fa-home'"></i></button>
                <button @click="logout()" class="text-xs bg-red-800 px-3 py-1 rounded border border-red-500"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>

        <aside class="w-full md:w-96 bg-white border-r border-gray-200 flex flex-col z-20 shadow-xl shrink-0 h-auto md:h-full" x-show="currentView === 'home'">
            <div class="hidden md:flex h-16 bg-red-700 text-white items-center px-6 justify-between shrink-0"><div class="font-bold">AUTOKIRIM <span class="text-xs font-normal opacity-70" x-text="selectedUser"></span></div></div>
            <div class="md:flex-1 md:overflow-y-auto p-4 space-y-4">
                <div class="bg-orange-50 p-3 rounded-xl border border-orange-200 shadow-sm animate-pulse" x-show="hasOldData">
                    <h3 class="text-xs font-bold text-orange-800 mb-1"><i class="fas fa-history"></i> DATA LAMA DITEMUKAN!</h3>
                    <button @click="migrateAllData()" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-2 rounded-lg text-xs font-bold shadow transition"><i class="fas fa-cloud-upload-alt mr-1"></i> UPLOAD DATA LAMA</button>
                </div>
                <div class="bg-gray-900 text-white p-3 rounded-xl shadow-lg border border-gray-700 flex justify-between items-center">
                    <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center text-yellow-400 text-lg"><i class="fas fa-robot"></i></div><div><p class="font-bold text-sm">AI Auto-Detect</p><p class="text-[10px] text-gray-400" x-text="autoDetect ? 'ON' : 'OFF'"></p></div></div>
                    <input type="checkbox" x-model="autoDetect" class="w-5 h-5 accent-green-500 cursor-pointer"/>
                </div>
                <div class="bg-red-50 p-3 rounded-xl border border-red-100" :class="autoDetect ? 'disabled-zone' : ''">
                    <label class="text-[10px] font-bold text-red-500 uppercase mb-2 block">Pengaturan</label>
                    <div class="flex gap-2 overflow-x-auto hide-scroll mb-2 pb-1">
                        <template x-for="mp in marketplaces" :key="mp.name"><button @click="selectedMp = mp.name" class="whitespace-nowrap px-3 py-2 rounded-lg text-xs font-bold border transition flex items-center gap-2 shrink-0" :class="selectedMp === mp.name ? 'bg-red-600 text-white border-red-600' : 'bg-white text-gray-500 border-gray-200'"><i class="fas" :class="mp.icon"></i> <span x-text="mp.name"></span></button></template>
                    </div>
                    <div x-show="selectedMp === 'Manual'" class="bg-white p-2 rounded-lg border border-red-100 mb-2 flex gap-2">
                        <button @click="isCODInput = true" class="flex-1 py-1.5 rounded text-xs font-bold border transition" :class="isCODInput ? 'bg-green-600 text-white border-green-600' : 'bg-gray-100 text-gray-400 border-gray-200'">COD</button>
                        <button @click="isCODInput = false" class="flex-1 py-1.5 rounded text-xs font-bold border transition" :class="!isCODInput ? 'bg-blue-600 text-white border-blue-600' : 'bg-gray-100 text-gray-400 border-gray-200'">Non-COD</button>
                    </div>
                    <select x-model="selectedCourier" class="w-full bg-white border-2 border-red-100 text-gray-800 text-sm font-bold rounded-xl p-2.5 outline-none"><template x-for="c in couriers" :key="c"><option :value="c" x-text="c"></option></template></select>
                </div>
                <div class="bg-gray-900 p-1 rounded-xl shadow-lg relative group overflow-hidden">
                    <div class="relative w-full h-48 md:h-56 bg-black rounded-lg overflow-hidden" :class="scanStatusClass">
                        <div x-show="!isCameraActive" @click="toggleCamera()" class="absolute inset-0 flex flex-col items-center justify-center cursor-pointer text-gray-500 z-10"><div class="w-14 h-14 rounded-full bg-gray-800 flex items-center justify-center mb-2"><i class="fas fa-camera text-2xl"></i></div><span class="text-[10px] font-bold uppercase tracking-widest text-gray-400">Ketuk untuk Scan</span></div>
                        <div id="reader" x-show="isCameraActive"></div>
                        <div x-show="isCameraActive" class="scan-overlay"><div class="scan-box"><div class="laser"></div></div></div>
                    </div>
                    <button @click="toggleCamera()" class="absolute bottom-3 right-3 w-10 h-10 rounded-full flex items-center justify-center shadow-lg bg-white/20 text-white z-20"><i class="fas" :class="isCameraActive ? 'fa-stop' : 'fa-play'"></i></button>
                </div>
                <div class="flex gap-2"><input type="text" id="barcodeInput" x-model="barcodeInput" @keydown.enter="preProcessScan()" class="w-full bg-white border-2 border-gray-200 text-gray-900 text-sm font-bold rounded-xl p-3 outline-none focus:border-red-500 uppercase font-mono" placeholder="KETIK RESI..." autocomplete="off"><button @click="preProcessScan()" class="bg-red-600 text-white px-4 rounded-xl"><i class="fas fa-arrow-right"></i></button></div>
                <div class="pt-2"><button @click="refreshData()" class="w-full bg-blue-50 hover:bg-blue-100 text-blue-600 py-3 rounded-xl font-bold text-xs mt-2 border border-blue-200 transition"><i class="fas fa-sync mr-1"></i> SINKRONISASI MANUAL</button></div>
                <div class="pt-4 mt-4 border-t border-gray-100">
                    <button @click="shareToWA()" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-bold shadow-md mb-2 flex items-center justify-center gap-2"><i class="fab fa-whatsapp text-lg"></i> SHARE LAPORAN WA</button>
                    <div class="grid grid-cols-2 gap-2 mb-2"><button @click="showPrintModal = true" class="bg-gray-800 text-white py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2"><i class="fas fa-print text-yellow-400"></i> MANIFEST</button><button @click="exportExcel()" class="bg-green-600 text-white py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2"><i class="fas fa-file-excel"></i> EXCEL</button></div>
                    <button @click="showDeleteModal = true" class="w-full bg-red-100 text-red-700 py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2 hover:bg-red-200 transition"><i class="fas fa-trash-alt"></i> HAPUS DATA DATABASE</button>
                </div>
            </div>
        </aside>

        <main class="flex-1 bg-white flex flex-col relative md:overflow-hidden" x-show="currentView === 'home'" x-transition.opacity>
            <div class="bg-white border-b sticky top-0 z-40 shadow-sm">
                <div class="flex items-center gap-3 px-4 py-2 overflow-x-auto hide-scroll bg-gray-50 border-b">
                    <div class="flex items-center gap-2 px-3 py-1 bg-gray-800 text-white rounded-full shrink-0"><span class="text-[10px] font-bold">TOTAL:</span><span class="text-xs font-bold" x-text="filteredData.length"></span></div>
                    <div class="flex items-center gap-2 px-3 py-1 bg-green-100 text-green-800 rounded-full shrink-0"><span class="text-[10px] font-bold">COD:</span><span class="text-xs font-bold" x-text="formatRupiah(totalCOD)"></span></div>
                    <div class="flex items-center gap-2 px-3 py-1 bg-blue-100 text-blue-800 rounded-full shrink-0"><span class="text-[10px] font-bold">NON:</span><span class="text-xs font-bold" x-text="formatRupiah(totalNonCOD)"></span></div>
                </div>
                <div class="p-2 space-y-2">
                    <div class="flex gap-2">
                        <div class="flex bg-gray-100 border border-gray-300 rounded-lg shrink-0"><input type="date" x-model="filterDate" class="bg-transparent text-gray-900 text-xs focus:ring-0 block p-2 font-bold border-none outline-none"><button @click="filterDate = ''" class="px-2 text-gray-400 hover:text-red-500 border-l border-gray-300"><i class="fas fa-times"></i></button></div>
                        <div class="relative flex-1"><div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"><i class="fas fa-search text-gray-400"></i></div><input type="text" x-model="searchQuery" class="bg-gray-100 border border-gray-300 text-gray-900 text-xs rounded-lg focus:ring-red-500 block w-full pl-10 p-2 font-bold uppercase" placeholder="Cari Resi..."></div>
                    </div>
                    <div class="flex gap-2 overflow-x-auto hide-scroll pb-1">
                        <button @click="activeFilter = 'ALL'" class="px-3 py-1 rounded-full border shrink-0 text-xs font-bold transition" :class="activeFilter === 'ALL' ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-500'">SEMUA</button>
                        <template x-for="(count, courier) in getSummary()" :key="courier"><button @click="activeFilter = (activeFilter === courier ? 'ALL' : courier)" class="px-3 py-1 rounded-full border shrink-0 text-xs font-bold transition flex items-center gap-1" :class="activeFilter === courier ? 'bg-red-600 text-white' : 'bg-red-50 text-red-500'"><span x-text="courier"></span><span class="bg-white/20 px-1.5 rounded text-[10px]" x-text="count"></span></button></template>
                    </div>
                </div>
            </div>

            <div class="md:flex-1 md:overflow-y-auto p-0 md:p-4 bg-gray-50 pb-32 md:pb-28"> 
                <div class="bg-white md:rounded-2xl md:shadow-sm border-b md:border border-gray-200 min-h-full">
                    <table class="w-full text-left table-fixed">
                        <thead class="bg-gray-100 border-b">
                            <tr>
                                <th class="p-3 text-[10px] font-bold text-gray-500 uppercase w-[25%] border-r border-gray-200">Waktu</th>
                                <th class="p-3 text-[10px] font-bold text-gray-500 uppercase w-[35%] border-r border-gray-200">Resi & Ekspedisi</th>
                                <th class="p-3 text-[10px] font-bold text-gray-500 uppercase w-[40%] text-right">Info & Harga</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <template x-for="item in filteredData" :key="item.code">
                                <tr class="hover:bg-red-50 transition cursor-pointer" @click="openEditModal(item)">
                                    <td class="p-3 align-top border-r border-gray-100">
                                        <div class="text-xs font-bold text-gray-800" x-text="item.dayName || '-'"></div>
                                        <div class="text-[10px] text-gray-600 font-mono mt-0.5" x-text="formatDateID(item.date)"></div>
                                        <div class="text-[10px] text-gray-500 font-mono mt-0.5" x-text="item.time"></div>
                                        <div class="mt-1 inline-block bg-gray-200 text-gray-600 px-1 rounded text-[8px]" x-text="item.admin || 'System'"></div>
                                    </td>
                                    <td class="p-3 align-top border-r border-gray-100">
                                        <div class="text-sm font-bold text-gray-800 font-mono tracking-wide break-all leading-tight mb-1" x-text="item.code"></div>
                                        <div class="flex flex-wrap gap-1">
                                            <span class="text-[9px] font-bold text-red-600 bg-red-50 px-1.5 py-0.5 rounded border border-red-100" x-text="item.courier"></span>
                                            <span class="text-[9px] font-bold text-white px-1.5 py-0.5 rounded shadow-sm" :class="getMpColor(item.marketplace)" x-text="item.marketplace"></span>
                                        </div>
                                    </td>
                                    <td class="p-3 align-top text-right">
                                        <div class="flex flex-col items-end gap-1 mb-2">
                                            <div class="text-xs font-bold px-2 py-1 rounded border inline-flex items-center gap-1" :class="item.isCOD ? 'text-green-600 bg-green-50 border-green-100' : 'text-blue-600 bg-blue-50 border-blue-100'">
                                                <span x-text="formatRupiah(item.price)"></span>
                                                <span class="text-[9px] uppercase opacity-70 border-l pl-1 ml-1" x-text="item.isCOD ? 'COD' : 'Non-COD'"></span>
                                            </div>
                                        </div>
                                        <div class="text-[9px] text-gray-600 truncate max-w-[100px] ml-auto"><i class="fas fa-user text-gray-400 mr-1"></i><span x-text="item.receiver || '-'"></span></div>
                                        <div class="text-[9px] text-gray-600 truncate max-w-[100px] ml-auto"><i class="fas fa-map-marker-alt text-gray-400 mr-1"></i><span x-text="item.destination || '-'"></span></div>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="filteredData.length === 0">
                                <td colspan="3" class="p-8 text-center text-gray-400 text-sm">
                                    <span x-show="!searchQuery && onlineData.length > 0">Tidak ada data di tanggal <b x-text="formatDateID(filterDate)"></b>.<br><span class="text-blue-500 cursor-pointer underline font-bold" @click="filterDate = ''">TAMPILKAN SEMUA DATA</span></span>
                                    <span x-show="!searchQuery && onlineData.length === 0">Belum ada data dari server.</span>
                                    <span x-show="searchQuery">Resi tidak ditemukan.</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <main class="flex-1 bg-gray-50 flex flex-col overflow-y-auto p-4" x-show="currentView === 'dashboard'" x-transition.opacity>
            <h2 class="text-xl font-bold text-gray-800 mb-4">Statistik Harian <span class="text-sm font-normal text-gray-500" x-text="formatDateID(filterDate)"></span></h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="bg-white p-4 rounded-2xl shadow-sm"><h3 class="text-sm font-bold text-gray-600 mb-2">Distribusi Ekspedisi</h3><canvas id="courierChart"></canvas></div>
                <div class="bg-white p-4 rounded-2xl shadow-sm"><h3 class="text-sm font-bold text-gray-600 mb-2">Perbandingan COD vs Non-COD</h3><canvas id="paymentChart"></canvas></div>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm"><h3 class="text-sm font-bold text-gray-600 mb-2">Kinerja Admin</h3><table class="w-full text-sm text-left"><thead class="bg-gray-100 text-gray-500"><tr><th class="p-2">Admin</th><th class="p-2">Jumlah Scan</th></tr></thead><tbody><template x-for="(count, user) in getAdminStats()" :key="user"><tr class="border-b last:border-0"><td class="p-2 font-bold" x-text="user"></td><td class="p-2" x-text="count + ' Paket'"></td></tr></template></tbody></table></div>
        </main>
    </div>

    <div x-show="showDeleteModal" class="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 backdrop-blur-sm" x-cloak x-transition.opacity>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600"><i class="fas fa-trash-alt text-2xl"></i></div>
            <h3 class="text-lg font-bold text-gray-800 mb-1">Hapus Data Database?</h3>
            <p class="text-xs text-gray-500 mb-6">Data di Google Sheet akan dihapus permanen.</p>
            <button @click="deleteOnlineData('today')" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-bold shadow-md mb-3 flex items-center justify-center gap-2"><i class="fas fa-calendar-day"></i> HAPUS HARI INI (<span x-text="formatDateID(filterDate || getTodayISO())"></span>)</button>
            <button @click="deleteOnlineData('all')" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 rounded-xl font-bold shadow-sm mb-4 flex items-center justify-center gap-2"><i class="fas fa-dumpster"></i> HAPUS SEMUA (RESET TOTAL)</button>
            <button @click="showDeleteModal = false" class="text-gray-400 text-xs font-bold hover:text-gray-600">BATALKAN</button>
        </div>
    </div>

    <div x-show="showDetailModal" class="fixed inset-0 bg-black/80 z-[100] flex items-start justify-center p-4 backdrop-blur-sm overflow-y-auto" x-cloak>
        <div class="bg-white w-full md:max-w-md rounded-2xl shadow-2xl overflow-hidden modal-enter mt-4 md:mt-10 mb-20">
            <div class="bg-gray-800 p-4 text-white flex justify-between items-center">
                <h3 class="font-bold flex items-center gap-2"><i class="fas" :class="isEditMode ? 'fa-edit' : 'fa-cloud-upload-alt'"></i> <span x-text="isEditMode ? 'Edit Paket' : 'Upload Paket'"></span></h3>
                <button @click="printThermal(tempItem)" class="text-xs bg-yellow-500 text-black px-2 py-1 rounded font-bold hover:bg-yellow-400"><i class="fas fa-print"></i> CETAK STRUK</button>
            </div>
            <div class="p-5 space-y-3 bg-gray-50">
                <div class="bg-white p-3 rounded-xl border border-gray-200 text-center mb-2"><p class="text-xl font-mono font-bold text-gray-800 break-all" x-text="tempItem.code"></p><div class="flex justify-center gap-2 mt-2"><span class="text-xs font-bold px-2 py-1 rounded bg-red-100 text-red-600" x-text="tempItem.courier"></span><span class="text-xs font-bold px-2 py-1 rounded bg-gray-100 text-gray-600" x-text="tempItem.marketplace"></span></div></div>
                <div class="bg-white p-3 rounded-xl border border-gray-300"><div class="flex justify-between items-center mb-2"><label class="text-[10px] font-bold text-gray-500 uppercase">Nominal Ongkir</label><div class="flex gap-1"><button @click="tempItem.isCOD = true" class="text-[9px] font-bold px-2 py-1 rounded border transition" :class="tempItem.isCOD ? 'bg-green-600 text-white border-green-600' : 'bg-gray-100 text-gray-400'">COD</button><button @click="tempItem.isCOD = false" class="text-[9px] font-bold px-2 py-1 rounded border transition" :class="!tempItem.isCOD ? 'bg-blue-600 text-white border-blue-600' : 'bg-gray-100 text-gray-400'">NON</button></div></div><input type="number" x-model="tempItem.price" class="w-full text-2xl font-bold text-center outline-none border-b-2 border-gray-200 focus:border-green-500 pb-2"></div>
                <div class="space-y-2"><input type="text" x-model="tempItem.receiver" class="w-full p-3 text-sm border border-gray-300 rounded-lg outline-none focus:border-red-500" placeholder="Nama Penerima"><div class="flex gap-2"><input type="text" x-model="tempItem.destination" class="w-full p-3 text-sm border border-gray-300 rounded-lg outline-none focus:border-red-500" placeholder="Kota Tujuan"><input type="text" x-model="tempItem.weight" class="w-24 p-3 text-sm border border-gray-300 rounded-lg outline-none focus:border-red-500 text-center" placeholder="Kg"></div></div>
                <div class="flex gap-2 mt-4"><button @click="showDetailModal = false" class="flex-1 py-3 rounded-xl font-bold text-gray-500 bg-gray-200">Batal</button><button @click="saveData()" class="flex-[2] bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-bold shadow-lg" x-text="isEditMode ? 'UPDATE DATA' : 'UPLOAD KE SERVER'"></button></div>
            </div>
        </div>
    </div>

    <div x-show="showPrintModal" class="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 backdrop-blur-sm" x-cloak x-transition.opacity>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 relative">
            <h3 class="font-bold flex items-center gap-2 mb-4 text-gray-800"><i class="fas fa-print text-yellow-500"></i> Cetak Surat Jalan</h3>
            <div class="space-y-2 mb-4 max-h-48 overflow-y-auto"><template x-for="(count, courier) in getSummary()" :key="courier"><button @click="printManifest(courier)" class="w-full flex justify-between items-center p-3 rounded-xl border hover:bg-red-50 hover:border-red-300 transition group"><span class="font-bold text-sm text-gray-700 group-hover:text-red-600" x-text="courier"></span><span class="bg-gray-100 text-xs font-bold px-2 py-1 rounded text-gray-600" x-text="count + ' Paket'"></span></button></template><div x-show="Object.keys(getSummary()).length === 0" class="text-center text-sm text-gray-400 py-4">Data kosong.</div></div>
            <button @click="showPrintModal = false" class="w-full py-2 bg-gray-200 hover:bg-gray-300 font-bold rounded-xl text-sm text-gray-600">Tutup</button>
        </div>
    </div>

    <audio id="beepSuccess" src="https://www.soundjay.com/button/beep-07.wav"></audio>
    <audio id="beepError" src="https://www.soundjay.com/button/beep-10.wav"></audio>

    <script>
        function appData() {
            return {
                apiUrl: 'https://script.google.com/macros/s/AKfycbw_qEwKjM-lOjxQDPSqrN9Pk-oXQp9gMYfkSDuDHzEol-BzQP77QcMRlwvMxEHWfRUEww/exec',

                isLoggedIn: sessionStorage.getItem('autokirim_session') === 'true',
                selectedUser: sessionStorage.getItem('autokirim_user') || '',
                loginPass: '', isLoading: false, loadingText: 'Menghubungkan...',
                onlineData: [],
                couriers: ['JNT Express', 'JNE Express', 'ID Express', 'Sicepat', 'SPX', 'Lazada Lex', 'Anteraja', 'Ninja', 'JNT Cargo'],
                marketplaces: [{name:'Shopee',icon:'fa-shopping-bag'},{name:'Tokopedia',icon:'fa-store'},{name:'Lazada',icon:'fa-heart'},{name:'TikTok',icon:'fa-music'},{name:'Manual',icon:'fa-pen'}],
                selectedCourier: 'JNT Express', selectedMp: 'Shopee', barcodeInput: '', 
                autoDetect: true, isCameraActive: false, html5QrCode: null, showDetailModal: false, showPrintModal: false, showDeleteModal: false, tempItem: {}, scanStatus: 'idle',
                isCODInput: true, searchQuery: '', activeFilter: 'ALL', isEditMode: false, currentView: 'home',
                filterDate: new Date().toLocaleDateString('en-CA'), hasOldData: false,
                courierChart: null, paymentChart: null,

                initApp() { this.filterDate = this.getTodayISO(); if(this.isLoggedIn) { this.refreshData(); this.checkAllOldData(); } },
                checkAllOldData() { const keys = ['autokirimV18', 'autokirimV25', 'autokirimV27', 'autokirimV28', 'autokirimV30', 'autokirimV31', 'autokirimV32']; this.hasOldData = keys.some(k => { const d = localStorage.getItem(k); return d && JSON.parse(d).length > 0; }); },
                async migrateAllData() {
                    if(!confirm("Pindahkan data lama ke Server?")) return;
                    const keys = ['autokirimV18', 'autokirimV25', 'autokirimV27', 'autokirimV28', 'autokirimV30', 'autokirimV31', 'autokirimV32'];
                    let allOldItems = []; keys.forEach(k => { const d = localStorage.getItem(k); if (d) allOldItems = allOldItems.concat(JSON.parse(d)); });
                    if (allOldItems.length === 0) return alert("Tidak ada data.");
                    this.isLoading = true; let successCount = 0;
                    for (let item of allOldItems) {
                        this.loadingText = `Mengupload ${successCount + 1}/${allOldItems.length}...`;
                        if(!item.date.includes('-')) { const p = item.date.split('/'); if(p.length === 3) item.date = `${p[2]}-${p[1]}-${p[0]}`; }
                        if(!item.dayName) { const d = new Date(item.date); const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu']; item.dayName = days[d.getDay()]; }
                        item.admin = this.selectedUser || 'System';
                        try { await fetch(this.apiUrl, { method: 'POST', body: JSON.stringify({ action: 'add', data: item }) }); successCount++; } catch (e) {}
                    }
                    keys.forEach(k => localStorage.removeItem(k)); this.isLoading = false; this.hasOldData = false; alert(`Selesai! ${successCount} data dipindahkan.`); this.refreshData();
                },

                doLogin() { if(this.loginPass === 'admin123' && this.selectedUser) { this.isLoggedIn = true; sessionStorage.setItem('autokirim_session', 'true'); sessionStorage.setItem('autokirim_user', this.selectedUser); this.refreshData(); this.checkAllOldData(); } else { alert("User belum dipilih atau Password Salah"); this.loginPass = ''; } },
                logout() { if(confirm('Keluar?')) { this.isLoggedIn = false; sessionStorage.removeItem('autokirim_session'); sessionStorage.removeItem('autokirim_user'); } },

                async refreshData() {
                    if (!this.apiUrl) return; this.isLoading = true;
                    try {
                        const res = await fetch(this.apiUrl, { method: 'POST', body: JSON.stringify({ action: 'get' }) });
                        if(res.ok) {
                            const data = await res.json();
                            this.onlineData = data.map(item => {
                                if(item.date) {
                                    const d = new Date(item.date);
                                    if (!isNaN(d.getTime())) {
                                        item.date = new Intl.DateTimeFormat('en-CA', { timeZone: 'Asia/Jakarta' }).format(d);
                                        const d2 = new Date(item.date);
                                        const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                                        item.dayName = days[d2.getDay()];
                                    } else if(item.date.length >= 10) item.date = item.date.substring(0, 10);
                                }
                                return item;
                            }).reverse(); 
                            if(this.currentView === 'dashboard') this.updateCharts();
                        }
                    } catch (e) { console.error(e); } this.isLoading = false;
                },

                async deleteOnlineData(type) {
                    const dateTarget = this.filterDate || this.getTodayISO();
                    if (!confirm(type === 'all' ? "YAKIN HAPUS SEMUA?" : `Hapus data tanggal ${this.formatDateID(dateTarget)}?`)) return;
                    this.showDeleteModal = false; this.isLoading = true; this.loadingText = "Menghapus...";
                    try { const res = await fetch(this.apiUrl, { method: 'POST', body: JSON.stringify({ action: 'delete', type: type, date: dateTarget }) }); const r = await res.json(); if (r.status === 'success') { alert(r.message); this.refreshData(); } else { alert(r.message); } } catch (e) { alert("Error: " + e); } this.isLoading = false;
                },

                async saveData() {
                    this.showDetailModal = false; this.isLoading = true; this.loadingText = 'Menyimpan...';
                    this.tempItem.admin = this.selectedUser;
                    try { const res = await fetch(this.apiUrl, { method: 'POST', body: JSON.stringify({ action: this.isEditMode ? 'edit' : 'add', data: this.tempItem }) }); const r = await res.json(); if (r.status === 'success') { this.triggerFeedback('success'); await this.refreshData(); } else { alert(r.message); } } catch (e) { alert("Error: " + e); }
                    this.isLoading = false; if(!this.isCameraActive) document.getElementById('barcodeInput').focus();
                },

                get filteredData() {
                    let data = this.onlineData;
                    if (this.filterDate) data = data.filter(i => i.date === this.filterDate);
                    if (this.searchQuery) { const q = this.searchQuery.toLowerCase(); data = data.filter(i => String(i.code).toLowerCase().includes(q) || String(i.receiver).toLowerCase().includes(q)); }
                    if (this.activeFilter !== 'ALL') data = data.filter(i => i.courier === this.activeFilter);
                    return data;
                },

                get totalCOD() { return this.filteredData.filter(i => i.isCOD).reduce((acc, curr) => acc + (parseInt(curr.price) || 0), 0); },
                get totalNonCOD() { return this.filteredData.filter(i => !i.isCOD).reduce((acc, curr) => acc + (parseInt(curr.price) || 0), 0); },
                get scanStatusClass() { return this.scanStatus === 'success' ? 'flash-success' : (this.scanStatus === 'error' ? 'flash-error' : ''); },
                getMpColor(mp) { return {'Shopee':'bg-orange-500','Tokopedia':'bg-green-500','Lazada':'bg-blue-600'}[mp] || 'bg-gray-400'; },
                formatRupiah(num) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num || 0); },
                formatDateID(dateString) { if(!dateString) return '-'; const [y, m, d] = dateString.split('-'); return `${d}/${m}/${y}`; },
                getTodayISO() { const d = new Date(); return new Intl.DateTimeFormat('en-CA', { timeZone: 'Asia/Jakarta' }).format(d); },

                preProcessScan(codeFromCamera = null) {
                    let code = codeFromCamera || this.barcodeInput.trim();
                    code = code.toUpperCase().replace(/\s+/g, '');
                    if(!code) return;
                    if(this.onlineData.some(i => i.code === code)) { this.triggerFeedback('error'); alert('Resi SUDAH ADA!'); if(!codeFromCamera) this.barcodeInput=''; return; }
                    this.triggerFeedback('success');
                    let finalCourier = this.selectedCourier;
                    if(this.autoDetect) {
                        if(code.startsWith('JP')||code.startsWith('JX')) finalCourier = 'JNT Express'; else if(code.startsWith('SPX')||code.startsWith('ID')) finalCourier = 'SPX'; else if(code.startsWith('TKP')) finalCourier = 'Anteraja'; else if(code.startsWith('LX')) finalCourier = 'Lazada Lex'; else if(code.startsWith('00')) finalCourier = 'Sicepat';
                    }
                    let currentIsCOD = (this.selectedMp === 'Manual') ? this.isCODInput : true;
                    let defaultPrice = (this.selectedMp === 'Manual' && !currentIsCOD) ? 0 : 0;
                    const d = new Date();
                    const dateStr = this.getTodayISO();
                    const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                    const dayName = days[d.getDay()];
                    const fullTime = d.toLocaleTimeString('id-ID', {hour12: false, timeZone: 'Asia/Jakarta'});
                    this.isEditMode = false;
                    this.tempItem = { code: code, courier: finalCourier, marketplace: this.selectedMp, isCOD: currentIsCOD, receiver: '', destination: '', weight: '', price: defaultPrice, time: fullTime, date: dateStr, dayName: dayName, admin: this.selectedUser };
                    setTimeout(() => { this.showDetailModal = true; setTimeout(() => document.getElementById('receiverInput')?.focus(), 100); this.barcodeInput = ''; }, 300);
                },

                openEditModal(item) { this.isEditMode = true; this.tempItem = JSON.parse(JSON.stringify(item)); this.tempItem.originalCode = item.code; this.showDetailModal = true; },
                triggerFeedback(type) { this.scanStatus = type; const a = document.getElementById(type === 'success' ? 'beepSuccess' : 'beepError'); if(a) { a.currentTime = 0; a.play().catch(()=>{}); } setTimeout(() => this.scanStatus = 'idle', 800); },
                toggleCamera() { if(this.isCameraActive) { if(this.html5QrCode) this.html5QrCode.stop().then(()=>{ this.html5QrCode.clear(); this.isCameraActive = false; }); } else { this.isCameraActive = true; this.$nextTick(()=>{ if(!navigator.mediaDevices) return alert("No Camera"); const cfg={fps:10,qrbox:{width:250,height:250}}; if(!this.html5QrCode) this.html5QrCode=new Html5Qrcode("reader"); this.html5QrCode.start({facingMode:"environment"},cfg,(t)=>{if(!this.showDetailModal && this.scanStatus==='idle') this.preProcessScan(t)}).catch(e=>{alert(e);this.isCameraActive=false;}); }); } },
                getSummary() { const c={}; this.filteredData.forEach(i=>{c[i.courier]=(c[i.courier]||0)+1}); return c; },
                
                exportExcel() {
                    const d = this.filteredData; if(d.length===0) return alert("Kosong");
                    let c="Tanggal,Hari,Jam,Ekspedisi,Resi,Penerima,Tujuan,Status,Nominal,Admin\n";
                    d.forEach(r=>{c+=`${this.formatDateID(r.date)},${r.dayName||'-'},${r.time},${r.courier},${r.code},"${r.receiver}","${r.destination}",${r.isCOD?'COD':'NON'},${r.price},${r.admin||''}\n`});
                    const l=document.createElement("a"); l.href="data:text/csv;charset=utf-8,"+encodeURI(c); l.download=`Laporan_${this.filterDate}.csv`; document.body.appendChild(l); l.click(); l.remove();
                },

                // --- PRINT MANIFEST FIXED ---
                printManifest(cn) {
                    const d = this.filteredData.filter(i=>i.courier===cn); if(d.length===0) return alert("Kosong");
                    const tQ=d.length; 
                    const dateP = this.formatDateID(this.filterDate) || 'SEMUA TANGGAL';
                    const timeP = new Date().toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' });

                    const w=window.open('','','width=900,height=600');
                    w.document.write(`
                        <html>
                        <head>
                            <title>Manifest ${cn}</title>
                            <style>
                                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; font-size: 12px; color: #333; }
                                .company-header { text-align: center; margin-bottom: 15px; }
                                .company-name { font-size: 16px; font-weight: bold; margin-bottom: 2px; text-transform: uppercase; color: #000; }
                                .company-address { font-size: 14px; color: #000; margin-bottom: 1px; } /* Font diperbesar */
                                .pos-id { font-weight: bold; margin-top: 3px; font-size: 12px; color: #000; }
                                .report-title { text-align: center; margin: 15px 0; border-top: 2px solid #000; border-bottom: 2px solid #000; padding: 8px 0; }
                                .report-title h2 { margin: 0; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
                                .report-title h3 { margin: 2px 0 0; font-size: 16px; color: #000; font-weight: 800; }
                                .meta-info { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: bold; font-size: 12px; padding: 0 10px; }
                                table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                                th, td { border: 1px solid #000; padding: 8px; text-align: left; } /* Border Hitam */
                                th { background-color: #f3f4f6; text-transform: uppercase; font-size: 10px; font-weight: 700; color: #000; }
                                td { font-size: 11px; }
                                .footer { display: flex; justify-content: space-between; margin-top: 50px; padding: 0 50px; }
                                .sign-box { text-align: center; width: 200px; }
                                .sign-line { margin-top: 60px; border-top: 1px solid #000; padding-top: 5px; font-size: 11px; font-weight: bold; }
                            </style>
                        </head>
                        <body>
                            <div class="company-header">
                                <div class="company-name">AUTOKIRIM TELUK GONG 2</div>
                                <div class="company-address">Jl. Teluk Gong Raya 3 RT.08/RW.10, Pejagalan, Kec. Penjaringan, Jakarta Utara 14440</div>
                                <div class="company-address">(Pasar Teluk Gong 2 Uniko 10)</div>
                                <div class="pos-id">Pickup POS : AK00031858</div>
                            </div>
                            
                            <div class="report-title">
                                <h2>PICKUP MANIFEST REPORT</h2>
                                <h3>${cn.toUpperCase()}</h3>
                            </div>

                            <div class="meta-info">
                                <div>Waktu Cetak: ${timeP}</div>
                                <div>Total Paket: ${tQ}</div>
                            </div>

                            <table>
                                <thead>
                                    <tr>
                                        <th style="width: 5%; text-align:center;">No</th>
                                        <th style="width: 25%">No. Resi</th>
                                        <th style="width: 20%">Marketplace</th>
                                        <th style="width: 35%">Penerima</th>
                                        <th style="width: 15%">Tipe</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${d.map((item, index) => `
                                        <tr>
                                            <td style="text-align:center">${index + 1}</td>
                                            <td style="font-family:monospace; font-weight:bold">${item.code}</td>
                                            <td>${item.marketplace}</td>
                                            <td>${item.receiver || '-'}</td>
                                            <td>${item.isCOD ? 'COD' : 'NON-COD'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>

                            <div class="footer">
                                <div class="sign-box">
                                    <p style="margin-bottom: 5px; font-size: 11px;">Diserahkan Oleh,</p>
                                    <div class="sign-line">Admin / Sender</div>
                                </div>
                                <div class="sign-box">
                                    <p style="margin-bottom: 5px; font-size: 11px;">Diterima Oleh,</p>
                                    <div class="sign-line">Kurir / Driver</div>
                                </div>
                            </div>
                            <script>window.print(); window.onafterprint = function() { window.close(); }</sc` + `ript>
                        </body>
                        </html>
                    `);
                    w.document.close();
                },

                printThermal(i) {
                    const t = `[C]<b>BUKTI SCAN</b>\n[L]Tgl:${this.formatDateID(i.date)} ${i.time}\n--------------------------------\n[L]Resi:${i.code}\n[L]Kurir:${i.courier}\n[L]Tipe:${i.isCOD?'COD':'NON'}\n[L]Rp:${this.formatRupiah(i.price)}\n--------------------------------\n[C]${i.receiver||'-'}\n[C]${i.destination||'-'}\n\n\n`;
                    window.location.href='rawbt:base64,'+btoa(t);
                },
                shareToWA() {
                    if(this.filteredData.length===0) return alert("Kosong");
                    let t = `*LAPORAN AUTOKIRIM*\nTgl: ${this.formatDateID(this.filterDate)}\nTotal: ${this.filteredData.length}\nCOD: ${this.formatRupiah(this.totalCOD)}\nNON: ${this.formatRupiah(this.totalNonCOD)}\n\n`;
                    const s = this.getSummary(); for(const [k,v] of Object.entries(s)) t+=`- ${k}: ${v}\n`;
                    window.open(`https://wa.me/?text=${encodeURIComponent(t)}`,'_blank');
                },
                toggleView() { this.currentView = this.currentView==='home'?'dashboard':'home'; if(this.currentView==='dashboard') this.$nextTick(()=>this.initCharts()); },
                getAdminStats() { const s={}; this.filteredData.forEach(i=>{const a=i.admin||'Unknown'; s[a]=(s[a]||0)+1;}); return s; },
                initCharts() { this.updateCharts(); },
                updateCharts() {
                    if(this.currentView!=='dashboard') return;
                    const s = this.getSummary();
                    if(this.courierChart) this.courierChart.destroy(); if(this.paymentChart) this.paymentChart.destroy();
                    const ctx1 = document.getElementById('courierChart'); if(ctx1) this.courierChart = new Chart(ctx1,{type:'pie',data:{labels:Object.keys(s),datasets:[{data:Object.values(s),backgroundColor:['#ef4444','#f97316','#22c55e','#3b82f6','#a855f7']}]}});
                    const c = this.filteredData.filter(i=>i.isCOD).length; const n = this.filteredData.length - c;
                    const ctx2 = document.getElementById('paymentChart'); if(ctx2) this.paymentChart = new Chart(ctx2,{type:'bar',data:{labels:['COD','Non-COD'],datasets:[{label:'Paket',data:[c,n],backgroundColor:['#22c55e','#3b82f6']}]}});
                }
            }
        }
    </script>
</body>
</html>
